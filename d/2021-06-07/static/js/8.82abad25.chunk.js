(this["webpackJsonpremote-faces-web"]=this["webpackJsonpremote-faces-web"]||[]).push([[8],{108:function(e,n,t){"use strict";t.d(n,"c",(function(){return r})),t.d(n,"b",(function(){return a})),t.d(n,"a",(function(){return c}));var r=function(e){return"object"===typeof e&&null!==e},a=function(e,n){return"string"===typeof e[n]},c=function(e,n){return r(e[n])}},144:function(e,n,t){"use strict";t.d(n,"a",(function(){return r}));var r=function(e){return new Promise((function(n){return setTimeout(n,e)}))}},189:function(e,n,t){"use strict";t.d(n,"c",(function(){return s})),t.d(n,"b",(function(){return u})),t.d(n,"d",(function(){return d})),t.d(n,"a",(function(){return p}));var r=t(4),a=t(2),c=t.n(a),i=t(3),o=new WeakMap,s=function(e,n){if(o.has(e))return e;o.set(e,!0);var t=function t(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3;if("ended"!==e.readyState){var a=n.getTransceivers().find((function(n){return n.receiver.track===e}));!a||"inactive"!==a.currentDirection&&"sendonly"!==a.currentDirection?r<64e3&&setTimeout((function(){t(2*r)}),r):(e.stop(),e.dispatchEvent(new Event("ended")))}};return e.addEventListener("mute",(function(){return t()})),e},u=function(e){return new Promise(function(){var n=Object(i.a)(c.a.mark((function n(t,r){var a,i,o,s;return c.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,a=new RTCPeerConnection,i=new RTCPeerConnection,a.addEventListener("icecandidate",(function(e){var n=e.candidate;n&&i.addIceCandidate(n)})),i.addEventListener("icecandidate",(function(e){var n=e.candidate;n&&a.addIceCandidate(n)})),i.addEventListener("track",(function(e){t(e.track)})),e.addEventListener("ended",(function(){a.close(),i.close()})),a.addTrack(e),n.next=10,a.createOffer();case 10:return o=n.sent,n.next=13,a.setLocalDescription(o);case 13:return n.next=15,i.setRemoteDescription(o);case 15:return n.next=17,i.createAnswer();case 17:return s=n.sent,n.next=20,i.setLocalDescription(s);case 20:return n.next=22,a.setRemoteDescription(s);case 22:n.next=27;break;case 24:n.prev=24,n.t0=n.catch(0),r(n.t0);case 27:case"end":return n.stop()}}),n,null,[[0,24]])})));return function(e,t){return n.apply(this,arguments)}}())},d=function(){var e=Object(i.a)(c.a.mark((function e(n){var t,r,a,o;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("video"===n.kind){e.next=2;break}throw new Error("track kind is not video");case 2:return t=document.createElement("canvas"),r=t.getContext("2d"),a=new ImageCapture(n),o=function(){var e=Object(i.a)(c.a.mark((function e(){var n;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,a.grabFrame();case 3:return n=e.sent,t.width=n.width,t.height=n.height,r.drawImage(n,0,0),e.abrupt("return",t.toDataURL("image/jpeg"));case 10:return e.prev=10,e.t0=e.catch(0),console.log("failed to grab frame from viedeo track",e.t0),e.abrupt("return",null);case 14:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(){return e.apply(this,arguments)}}(),e.abrupt("return",{getImage:o});case 7:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),f=function(e){return new Promise((function(n,t){var r=new Image;r.onload=function(){return n(r)},r.onerror=t,r.src=e}))},p=function(){var e=document.createElement("canvas"),n=e.getContext("2d"),t=e.captureStream().getVideoTracks();return{videoTrack:Object(r.a)(t,1)[0],setImage:function(){var t=Object(i.a)(c.a.mark((function t(r){var a;return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,f(r);case 2:a=t.sent,e.width=a.width,e.height=a.height,n.drawImage(a,0,0);case 6:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()}}},226:function(e,n){},232:function(e,n){},405:function(e,n){},408:function(e,n){},423:function(e,n){},426:function(e,n){},475:function(e,n){},476:function(e,n){},49:function(e,n,t){"use strict";t.r(n),t.d(n,"createRoom",(function(){return k}));var r=t(101),a=t(2),c=t.n(a),i=t(3),o=t(273),s=t(404),u=t.n(s),d=t(1522),f=t.n(d),p=t(144),v=t(10),l=t(6),b=t(108),x=t(23),h=0,m={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:0.peerjs.com:3478",username:"peerjs",credential:"peerjsp"}],sdpSemantics:"unified-plan"},w=function(){var e=new Map,n=function(n,t,r){var a,c=e.get(n.peer);c&&r.split(/[\r\n]+/).forEach((function(e){if(e.startsWith("a=mid:"))a=e.slice("a=mid:".length);else if(e.startsWith("a=msid:")){e.slice("a=msid:".length).split(" ").forEach((function(e){var n=t[e];"string"===typeof n&&(c.remoteMediaTypes[a]=n)}))}}))};return{setAcceptingMediaTypes:function(n,t){var r=e.get(n.peer);r&&(r.acceptingMediaTypes=t)},getAcceptingMediaTypes:function(n){var t=e.get(n.peer);return t?t.acceptingMediaTypes:[]},addConn:function(n,t){if(e.get(n))throw new Error("addConn: already exists");var r={peerIndex:h+=1,peer:n,userId:t,sendPc:new RTCPeerConnection(m),recvPc:new RTCPeerConnection(m)};return e.set(r.peer,{conn:r,acceptingMediaTypes:[],remoteMediaTypes:{}}),r},getConn:function(n){var t=e.get(n);return t?t.conn:null},findConn:function(n){var t=Array.from(e.values()).find((function(e){return e.conn.peerIndex===n}));return t?t.conn:null},delConn:function(n){var t=e.get(n.peer);if(!t||t.conn!==n)throw new Error("delConn: does not exist");e.delete(n.peer),n.sendPc.close(),n.recvPc.close()},getPeerIndexList:function(){return Array.from(e.values()).map((function(e){return e.conn.peerIndex}))},forEachConns:function(n){Array.from(e.values()).forEach((function(e){n(e.conn)}))},forEachConnsAcceptingMedia:function(n,t){Array.from(e.values()).forEach((function(e){e.acceptingMediaTypes.includes(n)&&t(e.conn)}))},size:function(){return e.size},getRemoteMediaType:function(n,t){var r=e.get(n.peer);return r&&r.remoteMediaTypes[t]||null},registerRemoteMediaType:function(e,t){Object(b.a)(t,"msid2mediaType")&&(Object(b.a)(t,"offer")&&Object(b.b)(t.offer,"sdp")&&n(e,t.msid2mediaType,t.offer.sdp),Object(b.a)(t,"answer")&&Object(b.b)(t.answer,"sdp")&&n(e,t.msid2mediaType,t.answer.sdp))}}},g=t(189),k=function(){var e=Object(i.a)(c.a.mark((function e(n,t,a,s,d,h){var m,k,y,O,j,I,T,P,E,C,M,D,S,A,R,L,N,J,W,_,z,F,G,U,V,Z,q,B,H,K,Q,X;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return m=!1,k=w(),y=[],O=n.slice(0,x.a),e.next=7,Object(v.h)(n.slice(x.a));case 7:return j=e.sent,a({type:"INITIALIZING_PEER",peerIndex:0}),e.next=11,u.a.create({repo:Object(v.j)(),config:{Addresses:{Swarm:[Object(l.d)()||"/dns4/wrtc-star1.par.dwebops.pub/tcp/443/wss/p2p-webrtc-star/"]},Discovery:{MDNS:{Enabled:!0},webRTCStar:{Enabled:!0}}}});case 11:return I=e.sent,e.next=14,I.id();case 14:return T=e.sent.id,(P=new f.a(I,O)).on("message",(function(e){return Z(e)})),P.on("peer joined",(function(){D(null)})),P.on("peer left",(function(e){var n=k.getConn(e);n&&(k.delConn(n),a({type:"CONNECTION_CLOSED",peerIndex:n.peerIndex}))})),E=function(){var e=Object(i.a)(c.a.mark((function e(n){var t,r;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Object(v.c)(n,j);case 3:if(null!==(t=e.sent)){e.next=6;break}return e.abrupt("return",void 0);case 6:return r=JSON.parse(t),console.log("decrypted payload",r),e.abrupt("return",r);case 11:return e.prev=11,e.t0=e.catch(0),console.info("Error in parsePayload",e.t0,n),e.abrupt("return",void 0);case 15:case"end":return e.stop()}}),e,null,[[0,11]])})));return function(n){return e.apply(this,arguments)}}(),C=function(){var e=Object(i.a)(c.a.mark((function e(n,t){var r,a,i,s,u,d,f;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,console.log("payload to encrypt",n,t),r=!0,a=!1,e.prev=4,s=Object(o.a)(Object(v.f)(JSON.stringify(t),j));case 6:return e.next=8,s.next();case 8:return u=e.sent,r=u.done,e.next=12,u.value;case 12:if(d=e.sent,r){e.next=19;break}f=d,P.broadcast(f);case 16:r=!0,e.next=6;break;case 19:e.next=25;break;case 21:e.prev=21,e.t0=e.catch(4),a=!0,i=e.t0;case 25:if(e.prev=25,e.prev=26,r||null==s.return){e.next=30;break}return e.next=30,s.return();case 30:if(e.prev=30,!a){e.next=33;break}throw i;case 33:return e.finish(30);case 34:return e.finish(25);case 35:e.next=40;break;case 37:e.prev=37,e.t1=e.catch(0),console.error("sendPayload",e.t1);case 40:case"end":return e.stop()}}),e,null,[[0,37],[4,21,25,35],[26,,30,34]])})));return function(n,t){return e.apply(this,arguments)}}(),M=function(){var e=Object(i.a)(c.a.mark((function e(n,t){var r,a,i,s,u,d,f;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,r=!0,a=!1,e.prev=3,s=Object(o.a)(Object(v.f)(JSON.stringify(t),j));case 5:return e.next=7,s.next();case 7:return u=e.sent,r=u.done,e.next=11,u.value;case 11:if(d=e.sent,r){e.next=18;break}f=d,P.sendTo(n.peer,f);case 15:r=!0,e.next=5;break;case 18:e.next=24;break;case 20:e.prev=20,e.t0=e.catch(3),a=!0,i=e.t0;case 24:if(e.prev=24,e.prev=25,r||null==s.return){e.next=29;break}return e.next=29,s.return();case 29:if(e.prev=29,!a){e.next=32;break}throw i;case 32:return e.finish(29);case 33:return e.finish(24);case 34:e.next=39;break;case 36:e.prev=36,e.t1=e.catch(0),console.error("sendPayloadDirectly",e.t1);case 39:case"end":return e.stop()}}),e,null,[[0,36],[3,20,24,34],[25,,29,33]])})));return function(n,t){return e.apply(this,arguments)}}(),D=function(){var e=Object(i.a)(c.a.mark((function e(n){var r;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!m){e.next=2;break}return e.abrupt("return");case 2:return r={userId:t,data:n,mediaTypes:y},e.next=5,C(O,r);case 5:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),S=function(){var e=Object(i.a)(c.a.mark((function e(n,r){var a,i;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!m){e.next=2;break}return e.abrupt("return");case 2:if(a=k.findConn(r)){e.next=5;break}return e.abrupt("return");case 5:return i={userId:t,data:n,mediaTypes:y},e.next=8,M(a,i);case 8:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),A=function(e){m||(e.length!==y.length&&k.forEachConns((function(n){var t={userId:n.userId,peerIndex:n.peerIndex,mediaTypes:k.getAcceptingMediaTypes(n)},r=n.recvPc.getTransceivers();n.recvPc.getReceivers().forEach((function(a){var c=r.find((function(e){return e.receiver===a})),i=null===c||void 0===c?void 0:c.mid,o=i&&k.getRemoteMediaType(n,i);o?"live"===a.track.readyState&&!y.includes(o)&&e.includes(o)&&h(o,Object(g.c)(a.track,n.recvPc),t):console.warn("failed to find media type from mid")}))})),y=e,D(null))},R=function(){var e=Object(i.a)(c.a.mark((function e(n,t){var a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=B(),e.next=3,M(n,{SDP:Object(r.a)(Object(r.a)({},t),{},{msid2mediaType:a})});case 3:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),L=function(){var e=Object(i.a)(c.a.mark((function e(n,t){var r,a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Object(b.c)(t)){e.next=2;break}return e.abrupt("return");case 2:if(Object(b.b)(t,"negotiationId")){e.next=5;break}return console.warn("negotiationId not found in SDP"),e.abrupt("return");case 5:if(r=t.negotiationId,k.registerRemoteMediaType(n,t),!Object(b.a)(t,"offer")){e.next=24;break}return e.prev=8,e.next=11,n.recvPc.setRemoteDescription(t.offer);case 11:return e.next=13,n.recvPc.createAnswer();case 13:return a=e.sent,e.next=16,n.recvPc.setLocalDescription(a);case 16:R(n,{negotiationId:r,answer:a}),e.next=22;break;case 19:e.prev=19,e.t0=e.catch(8),console.info("handleSDP offer failed",e.t0);case 22:e.next=37;break;case 24:if(!Object(b.a)(t,"answer")){e.next=36;break}return N.get(n)===r&&N.delete(n),e.prev=26,e.next=29,n.sendPc.setRemoteDescription(t.answer);case 29:e.next=34;break;case 31:e.prev=31,e.t1=e.catch(26),console.info("handleSDP answer failed",e.t1);case 34:e.next=37;break;case 36:console.warn("unknown SDP",t);case 37:case"end":return e.stop()}}),e,null,[[8,19],[26,31]])})));return function(n,t){return e.apply(this,arguments)}}(),N=new WeakMap,J=function(e){var n=N.has(e);if(N.set(e,Object(v.j)()),!n){var t=function(){var n=Object(i.a)(c.a.mark((function n(){var r,a;return c.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(r=N.get(e)){n.next=3;break}return n.abrupt("return");case 3:if("closed"!==e.sendPc.signalingState){n.next=6;break}return N.delete(e),n.abrupt("return");case 6:return n.next=8,e.sendPc.createOffer();case 8:return a=n.sent,n.next=11,e.sendPc.setLocalDescription(a);case 11:return n.next=13,R(e,{negotiationId:r,offer:a});case 13:return n.next=15,Object(p.a)(5e3);case 15:t();case 16:case"end":return n.stop()}}),n)})));return function(){return n.apply(this,arguments)}}();t()}},W=function(e,n){M(e,{ICE:n})},_=function(e,n){if(Object(b.c)(n))if(Object(b.b)(n,"direction"))if(Object(b.a)(n,"candidate"))try{"send"===n.direction?e.recvPc.addIceCandidate(n.candidate):"recv"===n.direction&&e.sendPc.addIceCandidate(n.candidate)}catch(t){console.info("handleCandidate failed",t)}else console.warn("candidate not found in ICE");else console.warn("direction not found in ICE")},z=function(){var e=Object(i.a)(c.a.mark((function e(n,t){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Array.isArray(t)||!t.every((function(e){return"string"===typeof e}))){e.next=5;break}return k.setAcceptingMediaTypes(n,t),e.next=4,Object(p.a)(5e3);case 4:Q(n);case 5:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),F=function(e,n){var t={userId:e.userId,peerIndex:e.peerIndex,mediaTypes:k.getAcceptingMediaTypes(e)};try{d(n,t)}catch(r){console.warn("receiveData",r)}},G=function(){var e=Object(i.a)(c.a.mark((function e(n,t){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,Object(b.c)(t)){e.next=3;break}return e.abrupt("return");case 3:L(n,t.SDP),_(n,t.ICE),z(n,t.mediaTypes),F(n,t.data),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),console.info("Error in handlePayload",e.t0,t);case 12:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(n,t){return e.apply(this,arguments)}}(),U=function(e,n){var t=k.addConn(e,n);return t.sendPc.addEventListener("icecandidate",(function(e){var n=e.candidate;n&&W(t,{direction:"send",candidate:n})})),t.recvPc.addEventListener("icecandidate",(function(e){var n=e.candidate;n&&W(t,{direction:"recv",candidate:n})})),t.recvPc.addEventListener("track",(function(e){var n=e.transceiver.mid,r=n&&k.getRemoteMediaType(t,n);if(r){var a={userId:t.userId,peerIndex:t.peerIndex,mediaTypes:k.getAcceptingMediaTypes(t)};h(r,Object(g.c)(e.track,t.recvPc),a)}else console.warn("failed to find media type from mid")})),s(t.peerIndex),a({type:"NEW_CONNECTION",peerIndex:t.peerIndex}),t},V=function(e){if(!Object(b.c)(e))return null;var n=e.userId;return"string"!==typeof n?null:n},Z=function(){var e=Object(i.a)(c.a.mark((function e(n){var t,r,i,o;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!m){e.next=2;break}return e.abrupt("return");case 2:if(n.from!==T){e.next=4;break}return e.abrupt("return");case 4:return e.next=6,E(n.data);case 6:if(void 0!==(t=e.sent)){e.next=9;break}return e.abrupt("return");case 9:if(r=V(t),(i=k.getConn(n.from))||(r?i=U(n.from,r):console.warn("cannot initialize conn without user id")),!i){e.next=15;break}return e.next=15,G(i,t);case 15:o=k.getPeerIndexList(),a({type:"CONNECTED_PEERS",peerIndexList:o});case 17:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),q=new Map,B=function(){var e={};return q.forEach((function(n,t){var r=n.stream;e[r.id]=t})),e},H=function(e,n){if(!m){if(q.has(e))throw new Error("track is already added for ".concat(e));var t=new MediaStream([n]);q.set(e,{stream:t,track:n}),k.forEachConnsAcceptingMedia(e,(function(e){try{e.sendPc.addTrack(n,t),J(e)}catch(r){if("InvalidAccessError"!==r.name)throw r}}))}},K=function(e){if(!m){var n=q.get(e);if(n){var t=n.track;q.delete(e),k.forEachConnsAcceptingMedia(e,(function(e){var n=e.sendPc.getSenders().find((function(e){return e.track===t}));n&&"closed"!==e.sendPc.signalingState&&(e.sendPc.removeTrack(n),J(e))}))}else console.log("track is already removed for",e)}},Q=function(e){var n=e.sendPc.getSenders(),t=k.getAcceptingMediaTypes(e);t.forEach((function(t){var r=q.get(t);if(r){var a=r.stream,c=r.track;n.every((function(e){return e.track!==c}))&&(e.sendPc.addTrack(c,a),J(e))}})),n.forEach((function(n){n.track&&(t.some((function(e){var t;return(null===(t=q.get(e))||void 0===t?void 0:t.track)===n.track}))||"closed"===e.sendPc.signalingState||(e.sendPc.removeTrack(n),J(e)))}))},X=function(){var e=Object(i.a)(c.a.mark((function e(){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return m=!0,e.next=3,P.leave();case 3:return e.next=5,I.stop();case 5:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),e.abrupt("return",{broadcastData:D,sendData:S,acceptMediaTypes:A,addTrack:H,removeTrack:K,dispose:X});case 46:case"end":return e.stop()}}),e)})));return function(n,t,r,a,c,i){return e.apply(this,arguments)}}()},509:function(e,n){},523:function(e,n){},528:function(e,n){},529:function(e,n){},562:function(e,n){},576:function(e,n){},583:function(e,n){},584:function(e,n){},606:function(e,n){}}]);
//# sourceMappingURL=8.82abad25.chunk.js.map