{"version":3,"sources":["utils/sleep.ts","hooks/useRoom.ts","utils/storage.ts","media/capture.ts","hooks/useFaceImages.ts","components/FaceImages.tsx","media/imagePresets.ts","hooks/useMomentaryChat.ts","utils/emoji.ts","components/WysiwygEditor.tsx","components/MomentaryChat.tsx","hooks/useNotification.ts","components/ControlPanel.tsx","components/SettingPanel.tsx","components/UserStatus.tsx","components/SelectivePane.tsx","components/SingleRoom.tsx","hooks/useNicknameMap.ts","media/devices.ts","hooks/useAvailableDevices.ts","media/video.ts","media/audio.ts","hooks/useFaceVideos.ts","utils/types.ts"],"names":["sleep","ms","Promise","resolve","setTimeout","createRoomEntry","roomId","userId","a","networkStatusListeners","Set","newPeerListeners","dataListeners","trackListeners","Map","trackCache","updateNetworkStatus","status","forEach","listener","notifyNewPeer","peerIndex","receiveData","data","info","receiveTrack","mediaType","track","trackCacheItems","get","set","add","listeners","createRoom","room","count","roomEntryMap","register","roomEntryKey","has","entry","networkStatusListener","newPeerListener","dataListener","trackListener","mediaTypeSet","keys","prevSize","size","acceptMediaTypes","Array","from","trackCacheItem","readyState","delete","unregister","dispose","broadcastData","sendData","addTrack","removeTrack","useRoomNetworkStatus","onNetworkStatus","useState","networkStatus","type","Error","err","message","useEffect","cleanup","ns","useRoomNewPeer","sendInitialData","useBroadcastData","pending","useRef","broadcastDataRef","useCallback","args","current","push","registered","splice","length","useRoomData","onRoomData","useRoomMedia","onTrack","setAddTrack","undefined","setStringItem","name","value","window","localStorage","setItem","e","console","getStringItem","getItem","captureImage","stream","ImageCapture","imageCapture","takePhoto","blob","createImageBitmap","srcImg","grabFrame","srcW","width","srcH","height","video","document","createElement","autoplay","setAttribute","style","display","position","bottom","body","appendChild","removeChild","srcObject","videoWidth","videoHeight","deviceId","constraints","navigator","mediaDevices","getUserMedia","getVideoTracks","canvas","ctx","getContext","dstW","dstH","ratio","Math","max","min","x","y","drawImage","stop","toDataURL","isImageData","isObject","image","nickname","liveMode","micOn","speakerOn","isFaceInfo","FaceImage","React","memo","statusMesg","obsoleted","muted","className","opacity","ref","videoEle","autoPlay","playsInline","src","alt","title","FaceImages","suspended","videoDeviceId","audioDeviceId","myImage","setMyImage","roomImages","setRoomImages","fatalError","setFatalError","lastDataRef","send","roomImage","received","Date","now","prev","find","item","map","changed","next","timer","checkObsoletedImage","twoMinAgo","tenMinAgo","filter","didCleanup","loop","clearTimeout","useFaceImages","useFaceVideos","faceStream","faceStreamMap","isReply","isArray","isChatItem","messageId","createdAt","text","inReplyTo","replies","every","isReplies","compareReply","b","countDiff","useMomentaryChat","chatList","setChatList","chatListRef","addChatItem","chatItem","replyMap","entries","sort","some","newList","pop","chat","sendChat","secureRandomId","replyChat","EmojiPicker","Picker","config","toolbar","balloonToolbar","link","addTargetToExternalLinks","WysiwygEditor","registerClear","onChange","onMetaEnter","editor","CustomEditor","onReady","sourceElement","addEventListener","event","metaKey","code","setData","plugins","addItems","character","initEditor","_event","getData","MAX_CHAT_TEXT_SIZE","getChatTime","toLocaleString","split","slice","MomentaryChatContentPart","openEmojiPicker","setOpenEmojiPicker","reply","onSelect","native","onClick","dangerouslySetInnerHTML","__html","DOMPurify","sanitize","ADD_ATTR","MomentaryChatContent","latestMessageId","scrollTop","scrollHeight","MomentaryChat","containerRef","clearRef","canSend","setCanSend","textRef","setText","t","sendText","sendNotification","notificationRef","mesg","Notification","permission","close","requestPermission","useNotification","latestChatItem","RegExp","test","clear","disabled","ControlPanel","setSuspended","setLiveMode","setMicOn","setSpeakerOn","secondColumnOpen","setSecondColumnOpen","target","initialConfigOpen","TextField","initialText","onUpdate","buttonLabel","placeholder","clearOnUpdate","onSubmit","preventDefault","SettingPanel","setNickname","setVideoDeviceId","setAudioDeviceId","configOpen","setConfigOpen","videoDevices","useVideoDevices","audioDevices","useAudioDevices","appLink","location","href","replace","o","readOnly","videoDevice","label","audioDevice","JSON","stringify","UserStatus","emoji","setEmoji","setStatusMesg","components","Welcome","lazy","SelectivePane","activePane","setActivePane","multiple","Object","includes","idx","indexOf","fallback","SuspenseFallback","initialNickname","initialVideoDeviceId","initialAudioDeviceId","SingleRoom","setRoomIdToUrl","thirdColumnOpen","setThirdColumnOpen","useNicknameMap","cache","createMapFromCache","nicknameMap","setNicknameMap","index","findIndex","lastUpdated","i","key","getVideoDeviceInfoList","enumerateDevices","devices","list","kind","getAudioDeviceInfoList","setDevices","deviceInfoList","getVideoStream","getFaceVideoStream","frameRate","exact","getAudioStream","audio","getAudioTracks","applyConstraints","echoCancellation","echoCancellationType","ideal","noiseSuppression","addTrackToStream","disposeStream","newStream","MediaStream","dispatchEvent","MediaStreamTrackEvent","getTracks","videoEnabled","audioEnabled","uniqueMediaId","setFaceStream","setFaceStreamMap","isMounted","s","oldStream","rest","addVideoTrack","addAudioTrack","videoStream","disposeVideo","videoTrack","removeVideoTrack","Event","audioStream","disposeAudio","audioTrack","removeAudioTrack","enabled","onaddtrack","removeEventListener","hasStringProp","prop","hasObjectProp"],"mappings":"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","file":"static/js/5.51679d49.chunk.js","sourcesContent":["export const sleep = (ms: number) =>\n  new Promise((resolve) => setTimeout(resolve, ms));\n","import { useEffect, useState, useCallback, useRef } from \"react\";\n\nimport { ReturnPromiseType } from \"../utils/types\";\nimport { PeerInfo, createRoom, NetworkStatus } from \"../network/room\";\n\ntype NetworkStatusListener = (status: NetworkStatus) => void;\ntype NewPeerListener = (peerIndex: number) => void;\ntype DataListener = (data: unknown, info: PeerInfo) => void;\ntype TrackListener = (track: MediaStreamTrack, info: PeerInfo) => void;\ntype TrackCacheItem = { track: MediaStreamTrack; info: PeerInfo };\ntype RoomEntry = {\n  room: ReturnPromiseType<typeof createRoom>;\n  networkStatusListeners: Set<NetworkStatusListener>;\n  newPeerListeners: Set<NewPeerListener>;\n  dataListeners: Set<DataListener>;\n  trackListeners: Map<string, Set<TrackListener>>; // key = mediaType\n  trackCache: Map<string, Set<TrackCacheItem>>; // key = mediaType\n  count: number;\n};\n\nconst createRoomEntry = async (\n  roomId: string,\n  userId: string\n): Promise<RoomEntry> => {\n  const networkStatusListeners = new Set<NetworkStatusListener>();\n  const newPeerListeners = new Set<NewPeerListener>();\n  const dataListeners = new Set<DataListener>();\n  const trackListeners = new Map<string, Set<TrackListener>>();\n  const trackCache = new Map<string, Set<TrackCacheItem>>();\n  const updateNetworkStatus = (status: NetworkStatus) => {\n    networkStatusListeners.forEach((listener) => {\n      listener(status);\n    });\n  };\n  const notifyNewPeer = (peerIndex: number) => {\n    newPeerListeners.forEach((listener) => {\n      listener(peerIndex);\n    });\n  };\n  const receiveData = (data: unknown, info: PeerInfo) => {\n    dataListeners.forEach((listener) => {\n      listener(data, info);\n    });\n  };\n  const receiveTrack = (\n    mediaType: string,\n    track: MediaStreamTrack,\n    info: PeerInfo\n  ) => {\n    let trackCacheItems = trackCache.get(mediaType);\n    if (!trackCacheItems) {\n      trackCacheItems = new Set<TrackCacheItem>();\n      trackCache.set(mediaType, trackCacheItems);\n    }\n    trackCacheItems.add({ track, info });\n    const listeners = trackListeners.get(mediaType);\n    if (listeners) {\n      listeners.forEach((listener) => {\n        listener(track, info);\n      });\n    }\n  };\n  const room = await createRoom(\n    roomId,\n    userId,\n    updateNetworkStatus,\n    notifyNewPeer,\n    receiveData,\n    receiveTrack\n  );\n  return {\n    room,\n    networkStatusListeners,\n    newPeerListeners,\n    dataListeners,\n    trackListeners,\n    trackCache,\n    count: 0,\n  };\n};\n\nconst roomEntryMap = new Map<string, Promise<RoomEntry>>();\nconst register = async (\n  roomId: string,\n  userId: string,\n  listeners: Readonly<{\n    networkStatusListener?: NetworkStatusListener;\n    newPeerListener?: NewPeerListener;\n    dataListener?: DataListener;\n    trackListener?: Readonly<{\n      mediaType: string;\n      listener: TrackListener;\n    }>;\n  }>\n) => {\n  const roomEntryKey = `${roomId}_${userId}`;\n  if (!roomEntryMap.has(roomEntryKey)) {\n    roomEntryMap.set(roomEntryKey, createRoomEntry(roomId, userId));\n  }\n  const entry = (await roomEntryMap.get(roomEntryKey)) as RoomEntry;\n  if (listeners.networkStatusListener) {\n    entry.networkStatusListeners.add(listeners.networkStatusListener);\n  }\n  if (listeners.newPeerListener) {\n    entry.newPeerListeners.add(listeners.newPeerListener);\n  }\n  if (listeners.dataListener) {\n    entry.dataListeners.add(listeners.dataListener);\n  }\n  if (listeners.trackListener) {\n    const { mediaType, listener } = listeners.trackListener;\n    const mediaTypeSet = new Set(entry.trackListeners.keys());\n    const prevSize = mediaTypeSet.size;\n    let trackListeners = entry.trackListeners.get(mediaType);\n    if (!trackListeners) {\n      trackListeners = new Set<TrackListener>();\n      entry.trackListeners.set(mediaType, trackListeners);\n    }\n    trackListeners.add(listener);\n    mediaTypeSet.add(mediaType);\n    if (prevSize !== mediaTypeSet.size) {\n      entry.room.acceptMediaTypes(Array.from(mediaTypeSet));\n    }\n    const trackCacheItems = entry.trackCache.get(mediaType);\n    if (trackCacheItems) {\n      trackCacheItems.forEach((trackCacheItem) => {\n        if (trackCacheItem.track.readyState === \"ended\") {\n          trackCacheItems.delete(trackCacheItem);\n          return;\n        }\n        listener(trackCacheItem.track, trackCacheItem.info);\n      });\n    }\n  }\n  entry.count += 1;\n  const unregister = () => {\n    if (listeners.networkStatusListener) {\n      entry.networkStatusListeners.delete(listeners.networkStatusListener);\n    }\n    if (listeners.newPeerListener) {\n      entry.newPeerListeners.delete(listeners.newPeerListener);\n    }\n    if (listeners.dataListener) {\n      entry.dataListeners.delete(listeners.dataListener);\n    }\n    if (listeners.trackListener) {\n      const { mediaType, listener } = listeners.trackListener;\n      const trackListeners = entry.trackListeners.get(mediaType);\n      if (trackListeners) {\n        trackListeners.delete(listener);\n        if (trackListeners.size === 0) {\n          entry.trackListeners.delete(mediaType);\n          entry.room.acceptMediaTypes(Array.from(entry.trackListeners.keys()));\n        }\n      }\n    }\n    entry.count -= 1;\n    if (entry.count <= 0) {\n      entry.room.dispose();\n      roomEntryMap.delete(roomEntryKey);\n    }\n  };\n  return {\n    broadcastData: entry.room.broadcastData,\n    sendData: entry.room.sendData,\n    addTrack: entry.room.addTrack,\n    removeTrack: entry.room.removeTrack,\n    unregister,\n  };\n};\n\nexport const useRoomNetworkStatus = (\n  roomId: string,\n  userId: string,\n  onNetworkStatus?: (networkStatus: NetworkStatus) => void\n) => {\n  const [networkStatus, updateNetworkStatus] = useState<NetworkStatus>();\n  if (networkStatus && networkStatus.type === \"UNKNOWN_ERROR\") {\n    throw new Error(`Network Error: ${networkStatus.err.message}`);\n  }\n  useEffect(() => {\n    let cleanup = () => {};\n    (async () => {\n      const { unregister } = await register(roomId, userId, {\n        networkStatusListener: (ns: NetworkStatus) => {\n          updateNetworkStatus(ns);\n          if (onNetworkStatus) onNetworkStatus(ns);\n        },\n      });\n      cleanup = unregister;\n    })();\n    return () => {\n      cleanup();\n    };\n  }, [roomId, userId, onNetworkStatus]);\n  return networkStatus;\n};\n\nexport const useRoomNewPeer = (\n  roomId: string,\n  userId: string,\n  sendInitialData: (send: (data: unknown) => void) => void\n) => {\n  useEffect(() => {\n    let cleanup = () => {};\n    (async () => {\n      const { unregister, sendData } = await register(roomId, userId, {\n        newPeerListener: (peerIndex) => {\n          sendInitialData((data) => sendData(data, peerIndex));\n        },\n      });\n      cleanup = unregister;\n    })();\n    return () => {\n      cleanup();\n    };\n  }, [roomId, userId, sendInitialData]);\n};\n\ntype BroadcastData = ReturnPromiseType<typeof createRoom>[\"broadcastData\"];\n\nexport const useBroadcastData = (roomId: string, userId: string) => {\n  const pending = useRef<Parameters<BroadcastData>[]>([]);\n  const broadcastDataRef = useRef<BroadcastData>();\n  const broadcastData = useCallback((...args: Parameters<BroadcastData>) => {\n    if (broadcastDataRef.current) {\n      broadcastDataRef.current(...args);\n    } else {\n      pending.current.push(args);\n    }\n  }, []);\n  useEffect(() => {\n    let cleanup = () => {};\n    (async () => {\n      const registered = await register(roomId, userId, {});\n      broadcastDataRef.current = registered.broadcastData;\n      cleanup = registered.unregister;\n      pending.current.forEach((args) => {\n        registered.broadcastData(...args);\n      });\n      pending.current.splice(0, pending.current.length);\n    })();\n    return () => {\n      cleanup();\n    };\n  }, [roomId, userId]);\n  return broadcastData;\n};\n\nexport const useRoomData = (\n  roomId: string,\n  userId: string,\n  onRoomData: (data: unknown, info: PeerInfo) => void\n) => {\n  useEffect(() => {\n    let cleanup = () => {};\n    (async () => {\n      const { unregister } = await register(roomId, userId, {\n        dataListener: onRoomData,\n      });\n      cleanup = unregister;\n    })();\n    return () => {\n      cleanup();\n    };\n  }, [roomId, userId, onRoomData]);\n};\n\nexport const useRoomMedia = (\n  roomId: string,\n  userId: string,\n  onTrack: (track: MediaStreamTrack, info: PeerInfo) => void,\n  mediaType?: string\n) => {\n  const [addTrack, setAddTrack] = useState<\n    (track: MediaStreamTrack) => () => void\n  >();\n  useEffect(() => {\n    let cleanup = () => {};\n    if (mediaType) {\n      (async () => {\n        const registered = await register(roomId, userId, {\n          trackListener: { mediaType, listener: onTrack },\n        });\n        setAddTrack(() => (track: MediaStreamTrack) => {\n          registered.addTrack(mediaType, track);\n          return () => registered.removeTrack(mediaType);\n        });\n        cleanup = () => {\n          setAddTrack(undefined);\n          registered.unregister();\n        };\n      })();\n    }\n    return () => {\n      cleanup();\n    };\n  }, [roomId, userId, onTrack, mediaType]);\n  return addTrack;\n};\n","type StringItemName =\n  | \"nickname\"\n  | \"config_hidden\"\n  | \"faceimage_video_device_id\"\n  | \"faceimage_audio_device_id\";\n\ntype JsonItemName = \"TODO2\" | \"TODO3\";\n\nexport const setStringItem = (name: StringItemName, value: string) => {\n  try {\n    window.localStorage.setItem(name, value);\n  } catch (e) {\n    console.info(\"Failed to save string to localStorage\", e);\n  }\n};\n\nexport const getStringItem = (name: StringItemName) => {\n  try {\n    return window.localStorage.getItem(name) || \"\";\n  } catch (e) {\n    // ignore\n    return \"\";\n  }\n};\n\nexport const setJsonItem = (name: JsonItemName, value: unknown) => {\n  try {\n    window.localStorage.setItem(name, JSON.stringify(value));\n  } catch (e) {\n    console.info(\"Failed to save json to localStorage\", e);\n  }\n};\n\nexport const getJsonItem = (name: JsonItemName): unknown | null => {\n  try {\n    return JSON.parse(window.localStorage.getItem(name) || \"\");\n  } catch (e) {\n    // ignore\n    return null;\n  }\n};\n\nexport const removeItem = (name: StringItemName | JsonItemName) => {\n  try {\n    window.localStorage.removeItem(name);\n  } catch (e) {\n    // ignore\n  }\n};\n","import { sleep } from \"../utils/sleep\";\n\nconst captureImage = async (stream: MediaStream, track: MediaStreamTrack) => {\n  if (typeof ImageCapture !== \"undefined\") {\n    const imageCapture = new ImageCapture(track);\n    await sleep(2000);\n    let srcImg: ImageBitmap;\n    try {\n      const blob = await imageCapture.takePhoto();\n      srcImg = await createImageBitmap(blob);\n    } catch (e) {\n      srcImg = await imageCapture.grabFrame();\n    }\n    const srcW = srcImg.width;\n    const srcH = srcImg.height;\n    return { srcImg, srcW, srcH };\n  }\n  const video = document.createElement(\"video\");\n  video.autoplay = true;\n  video.setAttribute(\"playsinline\", \"\");\n  video.style.display = \"block\";\n  video.style.width = \"1px\";\n  video.style.height = \"1px\";\n  video.style.position = \"absolute\";\n  video.style.bottom = \"0\";\n  document.body.appendChild(video);\n  const dispose = () => {\n    document.body.removeChild(video);\n  };\n  video.srcObject = stream;\n  await sleep(2000);\n  const srcImg = video;\n  const srcW = video.videoWidth;\n  const srcH = video.videoHeight;\n  return { srcImg, srcW, srcH, dispose };\n};\n\nexport const takePhoto = async (deviceId?: string) => {\n  const constraints = deviceId\n    ? {\n        video: { deviceId },\n      }\n    : { video: true };\n  const stream = await navigator.mediaDevices.getUserMedia(constraints);\n  const [track] = stream.getVideoTracks();\n  const canvas = document.createElement(\"canvas\");\n  const ctx = canvas.getContext(\"2d\") as CanvasRenderingContext2D;\n  const dstW = 72;\n  const dstH = 72;\n  canvas.width = dstW;\n  canvas.height = dstH;\n  const { srcImg, srcW, srcH, dispose } = await captureImage(stream, track);\n  const ratio = Math.max(dstW / srcW, dstH / srcH);\n  const width = Math.min(srcW, dstW / ratio);\n  const height = Math.min(srcH, dstH / ratio);\n  const x = (srcW - width) / 2;\n  const y = (srcH - height) / 2;\n  ctx.drawImage(srcImg, x, y, width, height, 0, 0, dstW, dstH);\n  if (dispose) {\n    dispose();\n  }\n  track.stop();\n  return canvas.toDataURL(\"image/jpeg\");\n};\n","import { useCallback, useEffect, useState, useRef } from \"react\";\n\nimport { isObject } from \"../utils/types\";\nimport { NEUTRAL_FACE } from \"../media/imagePresets\";\nimport { takePhoto } from \"../media/capture\";\nimport {\n  useRoomData,\n  useBroadcastData,\n  useRoomNetworkStatus,\n  useRoomNewPeer,\n} from \"./useRoom\";\n\ntype ImageUrl = string;\n\ntype FaceInfo = {\n  nickname: string;\n  message: string;\n  liveMode: boolean;\n  micOn: boolean;\n  speakerOn: boolean;\n};\n\nconst isFaceInfo = (x: unknown): x is FaceInfo =>\n  isObject(x) &&\n  typeof (x as { nickname: unknown }).nickname === \"string\" &&\n  typeof (x as { message: unknown }).message === \"string\" &&\n  typeof (x as { liveMode: unknown }).liveMode === \"boolean\" &&\n  typeof (x as { micOn: unknown }).micOn === \"boolean\" &&\n  typeof (x as { speakerOn: unknown }).speakerOn === \"boolean\";\n\ntype ImageData = {\n  image: ImageUrl;\n  info: FaceInfo;\n};\n\nconst isImageData = (x: unknown): x is ImageData =>\n  isObject(x) &&\n  typeof (x as { image: unknown }).image === \"string\" &&\n  isFaceInfo((x as { info: unknown }).info);\n\ntype RoomImage = ImageData & {\n  userId: string;\n  received: number; // in milliseconds\n  obsoleted: boolean;\n  peerIndex: number;\n};\n\nexport const useFaceImages = (\n  roomId: string,\n  userId: string,\n  nickname: string,\n  statusMesg: string,\n  suspended: boolean,\n  liveMode: boolean,\n  micOn: boolean,\n  speakerOn: boolean,\n  deviceId?: string\n) => {\n  const [myImage, setMyImage] = useState<ImageUrl>();\n  const [roomImages, setRoomImages] = useState<RoomImage[]>([]);\n\n  const [fatalError, setFatalError] = useState<Error>();\n  if (fatalError) {\n    throw fatalError;\n  }\n\n  const lastDataRef = useRef<ImageData>();\n  useRoomNewPeer(\n    roomId,\n    userId,\n    useCallback((send) => {\n      if (lastDataRef.current) {\n        send(lastDataRef.current);\n      }\n    }, [])\n  );\n\n  const broadcastData = useBroadcastData(roomId, userId);\n  useRoomData(\n    roomId,\n    userId,\n    useCallback((data, info) => {\n      if (!isImageData(data)) return;\n      const roomImage = {\n        ...data,\n        userId: info.userId,\n        received: Date.now(),\n        obsoleted: false,\n        peerIndex: info.peerIndex,\n      };\n      setRoomImages((prev) => {\n        const found = prev.find((item) => item.userId === roomImage.userId);\n        if (!found) {\n          return [...prev, roomImage];\n        }\n        return prev.map((item) =>\n          item.userId === roomImage.userId ? roomImage : item\n        );\n      });\n    }, [])\n  );\n\n  useRoomNetworkStatus(\n    roomId,\n    userId,\n    useCallback((networkStatus) => {\n      if (networkStatus && networkStatus.type === \"CONNECTION_CLOSED\") {\n        const { peerIndex } = networkStatus;\n        setRoomImages((prev) => {\n          let changed = false;\n          const next = prev.map((item) => {\n            if (item.peerIndex === peerIndex) {\n              changed = true;\n              return { ...item, obsoleted: true };\n            }\n            return item;\n          });\n          return changed ? next : prev;\n        });\n      }\n    }, [])\n  );\n\n  useEffect(() => {\n    const checkObsoletedImage = () => {\n      const twoMinAgo = Date.now() - 2 * 60 * 1000;\n      const tenMinAgo = Date.now() - 10 * 60 * 1000;\n      setRoomImages((prev) => {\n        let changed = false;\n        const next = prev\n          .map((item) => {\n            if (item.received < twoMinAgo && !item.obsoleted) {\n              changed = true;\n              return { ...item, obsoleted: true };\n            }\n            if (item.received < tenMinAgo && item.obsoleted) {\n              changed = true;\n              return null;\n            }\n            return item;\n          })\n          .filter((item) => item) as typeof prev;\n\n        return changed ? next : prev;\n      });\n    };\n    let didCleanup = false;\n    let timer: NodeJS.Timeout;\n    const loop = async () => {\n      if (didCleanup) return;\n      try {\n        checkObsoletedImage();\n        const image = suspended ? NEUTRAL_FACE : await takePhoto(deviceId);\n        if (didCleanup) return;\n        setMyImage(image);\n        const info: FaceInfo = {\n          nickname,\n          message: statusMesg,\n          liveMode,\n          micOn,\n          speakerOn,\n        };\n        const data: ImageData = {\n          image,\n          info,\n        };\n        broadcastData(data);\n        lastDataRef.current = data;\n      } catch (e) {\n        setFatalError(e);\n      }\n      timer = setTimeout(loop, 2 * 60 * 1000);\n    };\n    loop();\n    return () => {\n      didCleanup = true;\n      clearTimeout(timer);\n    };\n  }, [\n    roomId,\n    userId,\n    deviceId,\n    nickname,\n    statusMesg,\n    suspended,\n    liveMode,\n    micOn,\n    speakerOn,\n    broadcastData,\n  ]);\n\n  return {\n    myImage,\n    roomImages,\n  };\n};\n","import React from \"react\";\n\nimport \"./FaceImages.css\";\nimport { BLANK_IMAGE } from \"../media/imagePresets\";\nimport { useFaceImages } from \"../hooks/useFaceImages\";\nimport { useFaceVideos } from \"../hooks/useFaceVideos\";\n\nconst FaceImage = React.memo<{\n  image?: string;\n  nickname: string;\n  statusMesg: string;\n  obsoleted?: boolean;\n  liveMode: boolean;\n  stream?: MediaStream;\n  muted: boolean;\n  micOn: boolean;\n  speakerOn: boolean;\n}>(\n  ({\n    image,\n    nickname,\n    statusMesg,\n    obsoleted,\n    liveMode,\n    stream,\n    muted,\n    micOn,\n    speakerOn,\n  }) => (\n    <div className=\"FaceImages-card\" style={{ opacity: obsoleted ? 0.2 : 1 }}>\n      {liveMode && !obsoleted && stream ? (\n        <video\n          className=\"FaceImages-photo\"\n          ref={(videoEle) => {\n            if (videoEle && videoEle.srcObject !== stream) {\n              // eslint-disable-next-line no-param-reassign\n              videoEle.srcObject = stream;\n            }\n          }}\n          autoPlay\n          playsInline\n          muted={muted}\n        />\n      ) : (\n        <img\n          src={image || BLANK_IMAGE}\n          className=\"FaceImages-photo\"\n          alt=\"myself\"\n        />\n      )}\n      <div className=\"FaceImages-name\">{nickname}</div>\n      <div\n        className=\"FaceImages-mesg\"\n        title={[...statusMesg][1] ? statusMesg : \"(No status message)\"}\n      >\n        {[...statusMesg][0]}\n      </div>\n      {liveMode && !obsoleted && stream && (\n        <div className=\"FaceImages-live-indicator\" title=\"Live Mode On\">\n          &#9673;\n        </div>\n      )}\n      {liveMode && !obsoleted && !stream && (\n        <div className=\"FaceImages-live-indicator\" title=\"Live Mode Available\">\n          &#9678;\n        </div>\n      )}\n      {liveMode && !obsoleted && (\n        <div className=\"FaceImages-mic-speaker-icons\">\n          {micOn && <span title=\"Mic On\">&#x1F3A4;</span>}\n          {speakerOn && <span title=\"Speaker On\">&#x1F508;</span>}\n        </div>\n      )}\n    </div>\n  )\n);\n\nexport const FaceImages = React.memo<{\n  roomId: string;\n  userId: string;\n  nickname: string;\n  statusMesg: string;\n  suspended: boolean;\n  liveMode: boolean;\n  micOn: boolean;\n  speakerOn: boolean;\n  videoDeviceId?: string;\n  audioDeviceId?: string;\n}>(\n  ({\n    roomId,\n    userId,\n    nickname,\n    statusMesg,\n    suspended,\n    liveMode,\n    micOn,\n    speakerOn,\n    videoDeviceId,\n    audioDeviceId,\n  }) => {\n    const { myImage, roomImages } = useFaceImages(\n      roomId,\n      userId,\n      nickname,\n      statusMesg,\n      suspended,\n      liveMode,\n      micOn,\n      speakerOn,\n      videoDeviceId\n    );\n    const { faceStream, faceStreamMap } = useFaceVideos(\n      roomId,\n      userId,\n      liveMode,\n      liveMode,\n      micOn,\n      videoDeviceId,\n      audioDeviceId\n    );\n\n    return (\n      <>\n        <FaceImage\n          image={myImage}\n          nickname={nickname}\n          statusMesg={statusMesg}\n          liveMode={liveMode}\n          stream={faceStream || undefined}\n          muted\n          micOn={micOn}\n          speakerOn={speakerOn}\n        />\n        {roomImages.map((item) => (\n          <FaceImage\n            key={item.userId}\n            image={item.image}\n            nickname={item.info.nickname}\n            statusMesg={item.info.message}\n            obsoleted={item.obsoleted}\n            liveMode={item.info.liveMode}\n            stream={(liveMode && faceStreamMap[item.userId]) || undefined}\n            muted={!speakerOn}\n            micOn={item.info.micOn}\n            speakerOn={item.info.speakerOn}\n          />\n        ))}\n      </>\n    );\n  }\n);\n","export const BLANK_IMAGE =\n  \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVQI12NgYAAAAAMAASDVlMcAAAAASUVORK5CYII=\";\n\nexport const NEUTRAL_FACE =\n  \"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAASABIAAD/4QBYRXhpZgAATU0AKgAAAAgAAgESAAMAAAABAAEAAIdpAAQAAAABAAAAJgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAASKADAAQAAAABAAAASAAAAAD/7QA4UGhvdG9zaG9wIDMuMAA4QklNBAQAAAAAAAA4QklNBCUAAAAAABDUHYzZjwCyBOmACZjs+EJ+/8AAEQgASABIAwEiAAIRAQMRAf/EAB8AAAEFAQEBAQEBAAAAAAAAAAABAgMEBQYHCAkKC//EALUQAAIBAwMCBAMFBQQEAAABfQECAwAEEQUSITFBBhNRYQcicRQygZGhCCNCscEVUtHwJDNicoIJChYXGBkaJSYnKCkqNDU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6g4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2drh4uPk5ebn6Onq8fLz9PX29/j5+v/EAB8BAAMBAQEBAQEBAQEAAAAAAAABAgMEBQYHCAkKC//EALURAAIBAgQEAwQHBQQEAAECdwABAgMRBAUhMQYSQVEHYXETIjKBCBRCkaGxwQkjM1LwFWJy0QoWJDThJfEXGBkaJicoKSo1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoKDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uLj5OXm5+jp6vLz9PX29/j5+v/bAEMAAwICAgICAwICAgMDAwMEBgQEBAQECAYGBQYJCAoKCQgJCQoMDwwKCw4LCQkNEQ0ODxAQERAKDBITEhATDxAQEP/bAEMBAwMDBAMECAQECBALCQsQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEP/dAAQABf/aAAwDAQACEQMRAD8A+q6KKKACiiigAooooAKKKKACiiigD//Q+q6KKKACms6oMs2M8fWkmlSCJ5pOFQEmuv8AANloen2L+K/EskIKoZlM5Ajt4hzk574718zxJxNQ4ehCMrOpP4U9Fpu35K621b+9ehgsBLFRlVfwx373eyX9aHNpperSxefFpN48fXcIjjFVd43tGcq69VYYI/Cve9P8UaZqOnQ6lpt3b3FlPH5kU8TAxunqD6Vw3ihvCXjrSZNW8P39nNcQu6R3dqwYeYvVGx1r5VeIMcO1OrKM49Uk4tel5ST9Ha/c6oZdGvLkinF9G3dfPRf10PP6KgtLj7RFuZdroxRx6MOtT1+l0K9PFUo16TvGSTT7p6o8mrSnRm6dRWadmFFFFamZ/9H6rooooAyPFUzQaHcSL2xu+mea0dTtLbxd4IvvDN7qH2W31K1MBlDAbcj36/Sm39nFf2U1lKPkmQofxrgpYNPurc+DvGlsZYoZA0RLlBKB91gR/Kvw7xay3EPEYfMo39mlytpX5Xe6fz/Q+/4RnTxGGqYP7d+Zeatb8LfiereC9P0vwh4Cs/A0GtRTQWtq9uZTMoJ3ZyRzx14rm/h14Q0/4Y+GLrQNL1n7cs10908hYfLu6DA6cd+9covw0+Fhjz/Y75x/z9P/AI1FFa+G/CAuLHwfp7LdahhTGJGctjoeTwBmvx/kVXmp0Kkpym07cu7+923PpqOWypzcqist2dT4eujdXWqODlBc8fXHP9K2qy/DmlNpGmJbyvvnkYyzN6uev+H4VqV/WvDWBq5blGHwlf44wSfr2+Wx+W5ziKeLx9WtS+Ft2/z+YUUUV7h5h//S+q6KKKACqWp6Rp+rw+Tf2yyDsT1H0NXaKzrUaeIg6dWKlF7p6ounUnRkp02011Ryx8A2GcJqN8sf9wSmtbSfDmlaNlrO3/eMPmkc7mP4mtOivKwfDuVZfV9vhsPGMu6Wv/AO/EZxj8XT9lWqyce1wooor2TzQooooA//0/quiiigAooooAKKKKACiiigAooooA//2Q==\";\n","import { useState, useCallback, useRef, useEffect } from \"react\";\n\nimport { secureRandomId } from \"../utils/crypto\";\nimport { isObject } from \"../utils/types\";\nimport { useRoomData, useBroadcastData, useRoomNewPeer } from \"./useRoom\";\n\nconst MAX_CHAT_LIST_SIZE = 100;\n\ntype Reply = [string, number];\n\nconst isReply = (x: unknown): x is Reply =>\n  Array.isArray(x) &&\n  x.length === 2 &&\n  typeof x[0] === \"string\" &&\n  typeof x[1] === \"number\";\n\nconst isReplies = (x: unknown): x is Reply[] =>\n  Array.isArray(x) && x.every(isReply);\n\nexport type ChatItem = {\n  nickname: string;\n  messageId: string;\n  createdAt: number; // in millisecond\n  text: string;\n  inReplyTo?: string; // messageId\n  replies?: Reply[];\n};\n\nconst isChatItem = (x: unknown): x is ChatItem =>\n  isObject(x) &&\n  typeof (x as { nickname: unknown }).nickname === \"string\" &&\n  typeof (x as { messageId: unknown }).messageId === \"string\" &&\n  typeof (x as { createdAt: unknown }).createdAt === \"number\" &&\n  typeof (x as { text: unknown }).text === \"string\" &&\n  (typeof (x as { inReplyTo: unknown }).inReplyTo === \"undefined\" ||\n    typeof (x as { inReplyTo: unknown }).inReplyTo === \"string\") &&\n  (typeof (x as { replies: unknown }).replies === \"undefined\" ||\n    isReplies((x as { replies: unknown }).replies));\n\ntype ChatData = {\n  chat: ChatItem;\n};\n\nconst isChatData = (x: unknown): x is ChatData =>\n  isObject(x) && isChatItem((x as { chat: unknown }).chat);\n\nconst compareReply = (a: Reply, b: Reply) => {\n  const countDiff = b[1] - a[1];\n  if (countDiff === 0) {\n    return a[0].length - b[0].length;\n  }\n  return countDiff;\n};\n\nexport const useMomentaryChat = (\n  roomId: string,\n  userId: string,\n  nickname: string\n) => {\n  const [chatList, setChatList] = useState<ChatItem[]>([]);\n  const chatListRef = useRef(chatList);\n  useEffect(() => {\n    chatListRef.current = chatList;\n  });\n\n  const addChatItem = useCallback((chatItem: ChatItem) => {\n    if (chatItem.inReplyTo) {\n      const { text, inReplyTo } = chatItem;\n      setChatList((prev) =>\n        prev.map((item) => {\n          if (item.messageId === inReplyTo) {\n            const replyMap = new Map(item.replies);\n            replyMap.set(text, (replyMap.get(text) || 0) + 1);\n            const replies = [...replyMap.entries()];\n            replies.sort(compareReply);\n            return { ...item, replies };\n          }\n          return item;\n        })\n      );\n      return;\n    }\n    setChatList((prev) => {\n      if (prev.some((item) => item.messageId === chatItem.messageId)) {\n        // Migration: This can happen if a peer with old version is connected.\n        return prev;\n      }\n      const newList = [chatItem, ...prev];\n      if (newList.length > MAX_CHAT_LIST_SIZE) {\n        newList.pop();\n      }\n      newList.sort((a, b) => b.createdAt - a.createdAt); // slow?\n      return newList;\n    });\n  }, []);\n\n  useRoomNewPeer(\n    roomId,\n    userId,\n    useCallback((send) => {\n      // TODO do not let all peers send initial data\n      chatListRef.current.forEach((chatItem) => {\n        const data: ChatData = {\n          chat: chatItem,\n        };\n        send(data);\n      });\n    }, [])\n  );\n\n  const broadcastData = useBroadcastData(roomId, userId);\n\n  useRoomData(\n    roomId,\n    userId,\n    useCallback(\n      (data) => {\n        if (isChatData(data)) {\n          addChatItem(data.chat);\n        }\n      },\n      [addChatItem]\n    )\n  );\n\n  const sendChat = useCallback(\n    (text: string) => {\n      const chatItem: ChatItem = {\n        nickname,\n        messageId: secureRandomId(),\n        createdAt: Date.now(),\n        text,\n      };\n      const data: ChatData = {\n        chat: chatItem,\n      };\n      broadcastData(data);\n      addChatItem(chatItem);\n    },\n    [broadcastData, nickname, addChatItem]\n  );\n\n  const replyChat = useCallback(\n    (text: string, inReplyTo: string) => {\n      const chatItem: ChatItem = {\n        nickname,\n        messageId: secureRandomId(),\n        createdAt: Date.now(),\n        text,\n        inReplyTo,\n      };\n      const data: ChatData = {\n        chat: chatItem,\n      };\n      broadcastData(data);\n      addChatItem(chatItem);\n    },\n    [broadcastData, nickname, addChatItem]\n  );\n\n  return {\n    chatList,\n    sendChat,\n    replyChat,\n  };\n};\n","import React from \"react\";\nimport \"emoji-mart/css/emoji-mart.css\";\nimport { BaseEmoji, Picker } from \"emoji-mart\";\n\nexport { Emoji } from \"emoji-mart\";\nexport type EmojiDataType = BaseEmoji;\n\n// we do not support custom emojis\nexport const EmojiPicker = Picker as React.ComponentType<\n  | Omit<React.ComponentProps<typeof Picker>, \"custom\" | \"onSelect\">\n  | {\n      onSelect: (emoji: BaseEmoji) => void;\n    }\n>;\n","// @ts-nocheck XXX ckeditor5 doesn't come with types\n\nimport React from \"react\";\nimport { CKEditor } from \"@ckeditor/ckeditor5-react\";\nimport CustomEditor from \"@daishi/ckeditor5-build-inline-custom\";\n\nimport \"./WysiwygEditor.css\";\n\nconst config = {\n  toolbar: [\n    \"specialCharacters\",\n    \"|\",\n    \"bold\",\n    \"italic\",\n    \"link\",\n    \"blockQuote\",\n    \"|\",\n    \"imageUpload\",\n    \"insertTable\",\n    \"mediaEmbed\",\n    \"|\",\n    \"undo\",\n    \"redo\",\n  ],\n  balloonToolbar: [\n    \"heading\",\n    \"|\",\n    \"bulletedList\",\n    \"numberedList\",\n    \"indent\",\n    \"outdent\",\n  ],\n  link: {\n    addTargetToExternalLinks: true,\n  },\n};\n\nconst initEditor = (editor) => {\n  editor.plugins.get(\"SpecialCharacters\").addItems(\"Emoji\", [\n    { title: \"smiley face\", character: \"\" },\n    { title: \"rocket\", character: \"\" },\n    { title: \"wind blowing face\", character: \"\" },\n    { title: \"floppy disk\", character: \"\" },\n    { title: \"heart\", character: \"\" },\n  ]);\n};\n\nexport const WysiwygEditor = React.memo<{\n  registerClear: (clear: () => void) => void;\n  onChange: (data: string) => void;\n  onMetaEnter: () => void;\n}>(({ registerClear, onChange, onMetaEnter }) => (\n  <CKEditor\n    editor={CustomEditor}\n    config={config}\n    onReady={(editor) => {\n      const onKeydown = (event: KeyboardEvent) => {\n        if (event.metaKey && event.code === \"Enter\") {\n          onMetaEnter();\n        }\n      };\n      editor.sourceElement.addEventListener(\"keydown\", onKeydown);\n      registerClear(() => {\n        editor.setData(\"\");\n      });\n      initEditor(editor);\n    }}\n    onChange={(_event, editor) => {\n      const data = editor.getData();\n      onChange(data);\n    }}\n  />\n));\n","import React, { useState, useRef, useEffect, useCallback } from \"react\";\nimport DOMPurify from \"dompurify\";\n\nimport \"./MomentaryChat.css\";\nimport { useMomentaryChat, ChatItem } from \"../hooks/useMomentaryChat\";\nimport { EmojiPicker } from \"../utils/emoji\";\nimport { WysiwygEditor } from \"./WysiwygEditor\";\nimport { useNotification } from \"../hooks/useNotification\";\n\nconst MAX_CHAT_TEXT_SIZE = 1 * 1024 * 1024;\n\ntype ChatList = ReturnType<typeof useMomentaryChat>[\"chatList\"];\ntype ReplyChat = ReturnType<typeof useMomentaryChat>[\"replyChat\"];\n\nconst sanitize = (text: string) => ({\n  __html: DOMPurify.sanitize(text, { ADD_ATTR: [\"target\"] }),\n});\n\nconst getChatTime = (item: ChatItem) =>\n  new Date(item.createdAt).toLocaleString().split(\" \")[1].slice(0, -3);\n\nconst MomentaryChatContentPart = React.memo<{\n  item: ChatItem;\n  replyChat: ReplyChat;\n}>(({ item, replyChat }) => {\n  const [openEmojiPicker, setOpenEmojiPicker] = useState(false);\n  const reply = (text: string) => replyChat(text, item.messageId);\n  return (\n    <li key={item.messageId} className=\"MomentaryChat-listPart\">\n      {openEmojiPicker && (\n        <EmojiPicker\n          onSelect={(e) => {\n            reply(e.native);\n            setOpenEmojiPicker(false);\n          }}\n          style={{ width: \"100%\" }}\n        />\n      )}\n      <div className=\"MomentaryChat-listPart-header\">\n        <div className=\"MomentaryChat-iconButton-container\">\n          <div className=\"MomentaryChat-iconButton\">\n            <button\n              type=\"button\"\n              onClick={() => {\n                setOpenEmojiPicker(!openEmojiPicker);\n              }}\n            >\n              +\n            </button>\n          </div>\n        </div>\n        <span className=\"MomentaryChat-nickname\">\n          {item.nickname || \"No Name\"}\n        </span>\n        <span className=\"MomentaryChat-time\">{getChatTime(item)}</span>\n      </div>\n      <div\n        className=\"MomentaryChat-text ck-content\"\n        dangerouslySetInnerHTML={sanitize(item.text)}\n      />\n      {(item.replies || []).map(([text, count]) => (\n        <button\n          key={text}\n          className=\"MomentaryChat-icon\"\n          type=\"button\"\n          onClick={() => reply(text)}\n        >\n          {text} {count}\n        </button>\n      ))}\n    </li>\n  );\n});\n\nconst MomentaryChatContent = React.memo<{\n  chatList: ChatList;\n  replyChat: ReplyChat;\n}>(({ chatList, replyChat }) => {\n  const chatListRef = useRef<HTMLUListElement | null>(null);\n  const latestMessageId = chatList[0]?.messageId;\n  useEffect(() => {\n    if (chatListRef.current && latestMessageId) {\n      chatListRef.current.scrollTop = chatListRef.current.scrollHeight;\n    }\n  }, [latestMessageId]);\n\n  return (\n    <ul className=\"MomentaryChat-list\" ref={chatListRef}>\n      {chatList.map((item) => (\n        <MomentaryChatContentPart\n          key={item.messageId}\n          item={item}\n          replyChat={replyChat}\n        />\n      ))}\n    </ul>\n  );\n});\n\nexport const MomentaryChat = React.memo<{\n  roomId: string;\n  userId: string;\n  nickname: string;\n}>(({ roomId, userId, nickname }) => {\n  const containerRef = useRef<HTMLDivElement | null>(null);\n  const { chatList, sendChat, replyChat } = useMomentaryChat(\n    roomId,\n    userId,\n    nickname\n  );\n\n  const clearRef = useRef<() => void>();\n  const registerClear = (clear: () => void) => {\n    clearRef.current = clear;\n  };\n\n  const [canSend, setCanSend] = useState(false);\n  const textRef = useRef(\"\");\n  const setText = useCallback((t: string) => {\n    textRef.current = t;\n    setCanSend(!!t && t.length <= MAX_CHAT_TEXT_SIZE);\n  }, []);\n  const sendText = useCallback(() => {\n    if (textRef.current && textRef.current.length <= MAX_CHAT_TEXT_SIZE) {\n      sendChat(textRef.current);\n      setText(\"\");\n      if (clearRef.current) {\n        clearRef.current();\n      }\n    }\n  }, [sendChat, setText]);\n\n  const sendNotification = useNotification();\n  const latestChatItem = chatList[0];\n  useEffect(() => {\n    if (\n      latestChatItem &&\n      latestChatItem.createdAt > Date.now() - 10 * 1000 &&\n      new RegExp(`@${nickname}\\\\b`).test(latestChatItem.text)\n    ) {\n      sendNotification(\"You got a new message!\");\n    }\n  }, [nickname, latestChatItem, sendNotification]);\n\n  return (\n    <div className=\"MomentaryChat-container\" ref={containerRef}>\n      <MomentaryChatContent chatList={chatList} replyChat={replyChat} />\n      <div className=\"MomentaryChat-editor\">\n        <WysiwygEditor\n          registerClear={registerClear}\n          onChange={setText}\n          onMetaEnter={sendText}\n        />\n      </div>\n      <div className=\"MomentaryChat-button\">\n        <button type=\"button\" onClick={sendText} disabled={!canSend}>\n          Send\n        </button>\n      </div>\n    </div>\n  );\n});\n","import { useEffect, useCallback, useRef } from \"react\";\n\nexport const useNotification = () => {\n  const notificationRef = useRef<Notification>();\n  const sendNotification = useCallback((mesg: string) => {\n    if (Notification.permission === \"granted\") {\n      if (notificationRef.current) {\n        notificationRef.current.close();\n      }\n      notificationRef.current = new Notification(mesg);\n    }\n  }, []);\n  useEffect(() => {\n    if (Notification.permission !== \"granted\") {\n      Notification.requestPermission();\n    }\n  }, []);\n  return sendNotification;\n};\n","import React, { Dispatch, SetStateAction } from \"react\";\n\nimport \"./ControlPanel.css\";\n\nexport const ControlPanel = React.memo<{\n  suspended: boolean;\n  setSuspended: Dispatch<SetStateAction<boolean>>;\n  liveMode: boolean;\n  setLiveMode: Dispatch<SetStateAction<boolean>>;\n  micOn: boolean;\n  setMicOn: Dispatch<SetStateAction<boolean>>;\n  speakerOn: boolean;\n  setSpeakerOn: Dispatch<SetStateAction<boolean>>;\n  secondColumnOpen: boolean;\n  setSecondColumnOpen: Dispatch<SetStateAction<boolean>>;\n}>(\n  ({\n    suspended,\n    setSuspended,\n    liveMode,\n    setLiveMode,\n    setMicOn,\n    setSpeakerOn,\n    secondColumnOpen,\n    setSecondColumnOpen,\n  }) => (\n    <div className=\"ControlPanel-container\">\n      <button\n        type=\"button\"\n        onClick={() => setSuspended((x) => !x)}\n        title={suspended ? \"Enable Camera\" : \"Disable Camera\"}\n      >\n        &#x1F4F7;\n        {suspended && <span className=\"ControlPanel-disabled\">&#10060;</span>}\n      </button>\n      <button\n        type=\"button\"\n        onClick={() => setSecondColumnOpen((x) => !x)}\n        title={secondColumnOpen ? \"Close Right Pane\" : \"Open Right Pane\"}\n      >\n        {secondColumnOpen ? <>&#9664;</> : <>&#9654;</>}\n      </button>\n      <button\n        type=\"button\"\n        onClick={() => setLiveMode((x) => !x)}\n        title={liveMode ? \"Disable Live Mode\" : \"Enable Live Mode\"}\n      >\n        &#x1F3A5;\n        {!liveMode && <span className=\"ControlPanel-disabled\">&#10060;</span>}\n      </button>\n      <div className=\"ControlPanel-select\">\n        &#x1F39B;\n        <select\n          onChange={(e) => {\n            switch (e.target.value) {\n              case \"off\":\n                setSpeakerOn(false);\n                setMicOn(false);\n                break;\n              case \"speaker\":\n                setSpeakerOn(true);\n                setMicOn(false);\n                break;\n              case \"mic\":\n                setSpeakerOn(true);\n                setMicOn(true);\n                break;\n              default:\n                throw new Error(\"no option\");\n            }\n          }}\n        >\n          <option value=\"off\">Audio Off</option>\n          <option value=\"speaker\">Speaker Only</option>\n          <option value=\"mic\">Mic + Speaker</option>\n        </select>\n      </div>\n    </div>\n  )\n);\n","import React, { Dispatch, SetStateAction, useEffect, useState } from \"react\";\n\nimport \"./SettingPanel.css\";\nimport { setStringItem, getStringItem } from \"../utils/storage\";\nimport { useRoomNetworkStatus } from \"../hooks/useRoom\";\nimport { useVideoDevices, useAudioDevices } from \"../hooks/useAvailableDevices\";\n\nconst initialConfigOpen = getStringItem(\"config_hidden\") !== \"true\";\n\nconst TextField = React.memo<{\n  initialText: string;\n  onUpdate: (text: string) => void;\n  buttonLabel?: string;\n  placeholder?: string;\n  clearOnUpdate?: boolean;\n}>(({ initialText, onUpdate, buttonLabel, placeholder, clearOnUpdate }) => {\n  const [text, setText] = useState(initialText);\n  const onSubmit = (event: React.FormEvent<HTMLFormElement>) => {\n    event.preventDefault();\n    if (text) {\n      onUpdate(text);\n      if (clearOnUpdate) {\n        setText(\"\");\n      }\n    }\n  };\n\n  return (\n    <form onSubmit={onSubmit}>\n      <input\n        value={text}\n        onChange={(e) => setText(e.target.value)}\n        placeholder={placeholder}\n      />\n      {buttonLabel && (\n        <button type=\"submit\" disabled={!text}>\n          {buttonLabel}\n        </button>\n      )}\n    </form>\n  );\n});\n\nexport const SettingPanel = React.memo<{\n  roomId: string;\n  userId: string;\n  nickname: string;\n  setNickname: Dispatch<SetStateAction<string>>;\n  videoDeviceId: string;\n  setVideoDeviceId: Dispatch<SetStateAction<string>>;\n  audioDeviceId: string;\n  setAudioDeviceId: Dispatch<SetStateAction<string>>;\n}>(\n  ({\n    roomId,\n    userId,\n    nickname,\n    setNickname,\n    videoDeviceId,\n    setVideoDeviceId,\n    audioDeviceId,\n    setAudioDeviceId,\n  }) => {\n    const [configOpen, setConfigOpen] = useState(initialConfigOpen);\n    useEffect(() => {\n      setStringItem(\"config_hidden\", configOpen ? \"false\" : \"true\");\n    }, [configOpen]);\n\n    const videoDevices = useVideoDevices();\n    const audioDevices = useAudioDevices();\n    const networkStatus = useRoomNetworkStatus(roomId, userId);\n\n    const appLink = `remote-faces://${window.location.href.replace(\n      /^https:\\/\\//,\n      \"\"\n    )}`;\n\n    return (\n      <div className=\"SettingPanel-container\">\n        <button\n          type=\"button\"\n          className=\"SettingPanel-config-toggle\"\n          onClick={() => setConfigOpen((o) => !o)}\n        >\n          Setting{configOpen ? <>&#9660;</> : <>&#9654;</>}\n        </button>\n        {configOpen && (\n          <div className=\"SettingPanel-config\">\n            <div className=\"SettingPanel-config-row\">\n              <span title=\"Share this link with your colleagues\">\n                Room Link:{\" \"}\n              </span>\n              <input value={window.location.href} readOnly />{\" \"}\n              <a href={appLink} title=\"Open this link in the desktop app\">\n                Open App\n              </a>\n            </div>\n            <div className=\"SettingPanel-config-row\">\n              Your Name:{\" \"}\n              <TextField\n                initialText={nickname}\n                onUpdate={(text) => {\n                  setNickname(text);\n                  setStringItem(\"nickname\", text);\n                }}\n                placeholder=\"Enter your name\"\n                buttonLabel=\"Set\"\n              />\n            </div>\n            <div className=\"SettingPanel-config-row\">\n              Select Camera:{\" \"}\n              <select\n                value={videoDeviceId}\n                onChange={(e) => {\n                  setVideoDeviceId(e.target.value);\n                  setStringItem(\"faceimage_video_device_id\", e.target.value);\n                }}\n              >\n                {videoDevices.map((videoDevice) => (\n                  <option\n                    key={videoDevice.deviceId}\n                    value={videoDevice.deviceId}\n                  >\n                    {videoDevice.label}\n                  </option>\n                ))}\n              </select>\n            </div>\n            <div className=\"SettingPanel-config-row\">\n              Select Mic:{\" \"}\n              <select\n                value={audioDeviceId}\n                onChange={(e) => {\n                  setAudioDeviceId(e.target.value);\n                  setStringItem(\"faceimage_audio_device_id\", e.target.value);\n                }}\n              >\n                {audioDevices.map((audioDevice) => (\n                  <option\n                    key={audioDevice.deviceId}\n                    value={audioDevice.deviceId}\n                  >\n                    {audioDevice.label}\n                  </option>\n                ))}\n              </select>\n            </div>\n            <div className=\"SettingPanel-status\">\n              {JSON.stringify(networkStatus)}\n            </div>\n          </div>\n        )}\n      </div>\n    );\n  }\n);\n","import React, { Dispatch, SetStateAction, useState } from \"react\";\n\nimport \"./UserStatus.css\";\nimport { Emoji, EmojiPicker, EmojiDataType } from \"../utils/emoji\";\n\nconst TextField = React.memo<{\n  initialText: string;\n  onUpdate: (text: string) => void;\n  buttonLabel?: string;\n  placeholder?: string;\n  clearOnUpdate?: boolean;\n}>(({ initialText, onUpdate, buttonLabel, placeholder, clearOnUpdate }) => {\n  const [text, setText] = useState(initialText);\n  const onSubmit = (event: React.FormEvent<HTMLFormElement>) => {\n    event.preventDefault();\n    if (text) {\n      onUpdate(text);\n      if (clearOnUpdate) {\n        setText(\"\");\n      }\n    }\n  };\n\n  return (\n    <form onSubmit={onSubmit}>\n      <input\n        value={text}\n        onChange={(e) => setText(e.target.value)}\n        placeholder={placeholder}\n      />\n      {buttonLabel && (\n        <button type=\"submit\" disabled={!text}>\n          {buttonLabel}\n        </button>\n      )}\n    </form>\n  );\n});\n\nexport const UserStatus = React.memo<{\n  emoji: EmojiDataType | null;\n  setEmoji: Dispatch<SetStateAction<EmojiDataType | null>>;\n  setStatusMesg: Dispatch<SetStateAction<string>>;\n}>(({ emoji, setEmoji, setStatusMesg }) => {\n  const [openEmojiPicker, setOpenEmojiPicker] = useState(false);\n  return (\n    <div className=\"UserStatus-container\">\n      <div className=\"UserStatus-status-area\">\n        <div className=\"UserStatus-emoji\">\n          <button\n            type=\"button\"\n            onClick={() => {\n              setOpenEmojiPicker(!openEmojiPicker);\n            }}\n          >\n            {emoji ? <Emoji emoji={emoji} size={10} /> : \":)\"}\n          </button>\n        </div>\n        {emoji && (\n          <div className=\"UserStatus-statusmesg\">\n            <TextField\n              initialText=\"\"\n              onUpdate={setStatusMesg}\n              placeholder=\"Enter status message...\"\n              buttonLabel=\"Set\"\n            />\n          </div>\n        )}\n        <button\n          type=\"button\"\n          onClick={() => {\n            setEmoji(null);\n            setStatusMesg(\"\");\n            setOpenEmojiPicker(false);\n          }}\n          disabled={!emoji}\n        >\n          Clear\n        </button>\n      </div>\n      {openEmojiPicker && (\n        <EmojiPicker\n          onSelect={(e) => {\n            setEmoji(e);\n            setOpenEmojiPicker(false);\n          }}\n          style={{ width: \"100%\" }}\n        />\n      )}\n    </div>\n  );\n});\n","import React, { Suspense, createElement, useState } from \"react\";\n\nimport { SuspenseFallback } from \"./SuspenseFallback\";\nimport \"./SelectivePane.css\";\n\nconst components = {\n  Welcome: React.lazy(() => import(\"./Welcome\")),\n  \"Spatial Area\": React.lazy(() => import(\"./SpatialArea\")),\n  \"Screen Share\": React.lazy(() => import(\"./ScreenShare\")),\n  \"White Board\": React.lazy(() => import(\"./CollabWhiteBoard\")),\n  \"Video Share\": React.lazy(() => import(\"./VideoShare\")),\n  \"Go Board\": React.lazy(() => import(\"./GoBoard\")),\n};\n\nexport const SelectivePane = React.memo<{\n  roomId: string;\n  userId: string;\n  nickname: string;\n  statusMesg: string;\n}>(({ roomId, userId, nickname, statusMesg }) => {\n  const [activePane, setActivePane] = useState<string[]>([\"Welcome\"]);\n  const togglePane = (name: string) => {\n    setActivePane((prev) => {\n      if (prev.includes(name)) {\n        return prev.filter((item) => item !== name);\n      }\n      return [...prev, name];\n    });\n  };\n  return (\n    <div className=\"SelectivePane-container\">\n      <div className=\"SelectivePane-select\">\n        &#9776;\n        <select\n          multiple\n          size={Object.keys(components).length}\n          value={activePane}\n          onChange={(e) => togglePane(e.target.value)}\n        >\n          {Object.keys(components).map((name) => {\n            const idx = activePane.indexOf(name);\n            if (idx >= 0) {\n              return (\n                <option key={name} value={name}>\n                  {`[${idx + 1}] ${name}`}\n                </option>\n              );\n            }\n            return (\n              <option key={name} value={name}>\n                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{name}\n              </option>\n            );\n          })}\n        </select>\n      </div>\n      <div className=\"SelectivePane-body\">\n        {activePane.map((name) => (\n          <Suspense key={name} fallback={<SuspenseFallback />}>\n            {createElement(components[name as keyof typeof components], {\n              roomId,\n              userId,\n              nickname,\n              statusMesg,\n            })}\n          </Suspense>\n        ))}\n      </div>\n    </div>\n  );\n});\n","import React, { useEffect, useState } from \"react\";\n\nimport \"./SingleRoom.css\";\nimport { setRoomIdToUrl } from \"../utils/url\";\nimport { getStringItem } from \"../utils/storage\";\nimport { useNicknameMap } from \"../hooks/useNicknameMap\";\nimport { FaceImages } from \"./FaceImages\";\nimport { MomentaryChat } from \"./MomentaryChat\";\nimport { ControlPanel } from \"./ControlPanel\";\nimport { SettingPanel } from \"./SettingPanel\";\nimport { UserStatus } from \"./UserStatus\";\nimport { SelectivePane } from \"./SelectivePane\";\nimport { EmojiDataType } from \"../utils/emoji\";\n\nconst initialNickname = getStringItem(\"nickname\");\nconst initialVideoDeviceId = getStringItem(\"faceimage_video_device_id\");\nconst initialAudioDeviceId = getStringItem(\"faceimage_audio_device_id\");\n\nexport const SingleRoom = React.memo<{\n  roomId: string;\n  userId: string;\n}>(({ roomId, userId }) => {\n  const [nickname, setNickname] = useState(initialNickname);\n  const [statusMesg, setStatusMesg] = useState(\"\");\n  const [emoji, setEmoji] = useState<EmojiDataType | null>(null);\n  useEffect(() => {\n    setRoomIdToUrl(roomId);\n  }, [roomId]);\n\n  const [videoDeviceId, setVideoDeviceId] = useState(initialVideoDeviceId);\n  const [audioDeviceId, setAudioDeviceId] = useState(initialAudioDeviceId);\n  const [suspended, setSuspended] = useState(false);\n  const [liveMode, setLiveMode] = useState(false);\n  const [micOn, setMicOn] = useState(false);\n  const [speakerOn, setSpeakerOn] = useState(false);\n  const [secondColumnOpen, setSecondColumnOpen] = useState(true);\n  const [thirdColumnOpen, setThirdColumnOpen] = useState(true);\n\n  useNicknameMap(roomId, userId); // to enable caching\n\n  return (\n    <div className=\"SingleRoom-container\">\n      <div className=\"SingleRoom-1st-column\">\n        <ControlPanel\n          suspended={suspended}\n          setSuspended={setSuspended}\n          liveMode={liveMode}\n          setLiveMode={setLiveMode}\n          micOn={micOn}\n          setMicOn={setMicOn}\n          speakerOn={speakerOn}\n          setSpeakerOn={setSpeakerOn}\n          secondColumnOpen={secondColumnOpen}\n          setSecondColumnOpen={setSecondColumnOpen}\n        />\n        <FaceImages\n          roomId={roomId}\n          userId={userId}\n          videoDeviceId={videoDeviceId}\n          audioDeviceId={audioDeviceId}\n          nickname={nickname}\n          statusMesg={`${emoji?.native || \" \"}${statusMesg}`}\n          suspended={suspended}\n          liveMode={liveMode}\n          micOn={micOn}\n          speakerOn={speakerOn}\n        />\n      </div>\n      <div\n        className=\"SingleRoom-2nd-column\"\n        style={{ width: secondColumnOpen ? \"inherit\" : \"0\" }}\n      >\n        <button\n          type=\"button\"\n          className=\"SingleRoom-toggle-3rd-column\"\n          onClick={() => setThirdColumnOpen((x) => !x)}\n          title={thirdColumnOpen ? \"Close Right Pane\" : \"Open Right Pane\"}\n        >\n          {thirdColumnOpen ? <>&#9664;</> : <>&#9654;</>}\n        </button>\n        <UserStatus\n          emoji={emoji}\n          setEmoji={setEmoji}\n          setStatusMesg={setStatusMesg}\n        />\n        <SettingPanel\n          roomId={roomId}\n          userId={userId}\n          nickname={nickname}\n          setNickname={setNickname}\n          videoDeviceId={videoDeviceId}\n          setVideoDeviceId={setVideoDeviceId}\n          audioDeviceId={audioDeviceId}\n          setAudioDeviceId={setAudioDeviceId}\n        />\n        <MomentaryChat roomId={roomId} userId={userId} nickname={nickname} />\n      </div>\n      <div\n        className=\"SingleRoom-3rd-column\"\n        style={{ display: thirdColumnOpen ? \"inherit\" : \"none\" }}\n      >\n        <SelectivePane\n          roomId={roomId}\n          userId={userId}\n          nickname={nickname}\n          statusMesg={`${emoji?.native || \" \"}${statusMesg}`}\n        />\n      </div>\n    </div>\n  );\n});\n\nexport default SingleRoom;\n","import { useCallback, useState } from \"react\";\n\nimport { isObject } from \"../utils/types\";\nimport { useRoomData } from \"./useRoom\";\n\ntype Entry = {\n  roomId: string;\n  userId: string;\n  nickname: string;\n  lastUpdated: number;\n};\nconst cache: Entry[] = [];\nconst TTL = 10 * 60 * 1000; // 10min\n\nconst createMapFromCache = (roomId: string) => {\n  const map: { [userId: string]: string } = {};\n  cache.forEach((entry) => {\n    if (entry.roomId === roomId) {\n      map[entry.userId] = entry.nickname;\n    }\n  });\n  return map;\n};\n\nconst hasInfoNickname = (x: unknown): x is { info: { nickname: string } } =>\n  isObject(x) &&\n  isObject((x as { info: unknown }).info) &&\n  typeof (x as { info: { nickname: unknown } }).info.nickname === \"string\";\n\nexport const useNicknameMap = (roomId: string, userId: string) => {\n  const [nicknameMap, setNicknameMap] = useState<{\n    [userId: string]: string;\n  }>(() => createMapFromCache(roomId));\n  useRoomData(\n    roomId,\n    userId,\n    useCallback(\n      (data, info) => {\n        if (!hasInfoNickname(data)) return;\n        const index = cache.findIndex(\n          (entry) => entry.roomId === roomId && entry.userId === info.userId\n        );\n        const now = Date.now();\n        if (index >= 0) {\n          if (cache[index].nickname !== data.info.nickname) {\n            cache[index].nickname = data.info.nickname;\n          }\n          cache[index].lastUpdated = now;\n        } else {\n          cache.push({\n            roomId,\n            userId: info.userId,\n            nickname: data.info.nickname,\n            lastUpdated: now,\n          });\n        }\n        for (let i = cache.length - 1; i >= 0; i -= 1) {\n          if (cache[i].lastUpdated + TTL < now) {\n            cache.splice(i, 1);\n          }\n        }\n        setNicknameMap((prev) => {\n          const map = createMapFromCache(roomId);\n          const keys = Object.keys(map);\n          if (\n            keys.length === Object.keys(prev).length &&\n            keys.every((key) => map[key] === prev[key])\n          ) {\n            return prev;\n          }\n          return map;\n        });\n      },\n      [roomId]\n    )\n  );\n  return nicknameMap;\n};\n","type DeviceInfo = {\n  label: string;\n  deviceId: string;\n};\n\nexport const getVideoDeviceInfoList = async () => {\n  try {\n    const devices = await navigator.mediaDevices.enumerateDevices();\n    const list: DeviceInfo[] = devices\n      .filter(({ kind }) => kind === \"videoinput\")\n      .map(({ label, deviceId }) => ({ label, deviceId }));\n    return list;\n  } catch (e) {\n    // ignored\n    return [];\n  }\n};\n\nexport const getAudioDeviceInfoList = async () => {\n  try {\n    const devices = await navigator.mediaDevices.enumerateDevices();\n    const list: DeviceInfo[] = devices\n      .filter(({ kind }) => kind === \"audioinput\")\n      .map(({ label, deviceId }) => ({ label, deviceId }));\n    return list;\n  } catch (e) {\n    // ignored\n    return [];\n  }\n};\n","import { useEffect, useState } from \"react\";\n\nimport {\n  getVideoDeviceInfoList,\n  getAudioDeviceInfoList,\n} from \"../media/devices\";\n\ntype VideoDeviceInfoList = ReturnType<\n  typeof getVideoDeviceInfoList\n> extends Promise<infer T>\n  ? T\n  : never;\n\nexport const useVideoDevices = () => {\n  const [devices, setDevices] = useState<VideoDeviceInfoList>([]);\n  useEffect(() => {\n    (async () => {\n      const deviceInfoList = await getVideoDeviceInfoList();\n      setDevices(deviceInfoList);\n    })();\n  }, []);\n  return devices;\n};\n\ntype AudioDeviceInfoList = ReturnType<\n  typeof getAudioDeviceInfoList\n> extends Promise<infer T>\n  ? T\n  : never;\n\nexport const useAudioDevices = () => {\n  const [devices, setDevices] = useState<AudioDeviceInfoList>([]);\n  useEffect(() => {\n    (async () => {\n      const deviceInfoList = await getAudioDeviceInfoList();\n      setDevices(deviceInfoList);\n    })();\n  }, []);\n  return devices;\n};\n","export const getVideoStream = async (deviceId?: string) => {\n  const constraints = deviceId\n    ? {\n        video: { deviceId },\n      }\n    : { video: true };\n  const stream = await navigator.mediaDevices.getUserMedia(constraints);\n  const [track] = stream.getVideoTracks();\n  const dispose = () => {\n    track.stop();\n  };\n  return {\n    stream,\n    dispose,\n  };\n};\n\nexport const getFaceVideoStream = async (deviceId?: string) => {\n  const constraints = {\n    video: {\n      deviceId,\n      frameRate: { max: 5 },\n      width: { exact: 72 },\n      height: { exact: 72 },\n    },\n  };\n  const stream = await navigator.mediaDevices.getUserMedia(constraints);\n  const [track] = stream.getVideoTracks();\n  const dispose = () => {\n    track.stop();\n  };\n  return {\n    stream,\n    dispose,\n  };\n};\n","export const getAudioStream = async (deviceId?: string) => {\n  const constraints = deviceId\n    ? {\n        audio: { deviceId },\n      }\n    : { audio: true };\n  const stream = await navigator.mediaDevices.getUserMedia(constraints);\n  const [track] = stream.getAudioTracks();\n  await track.applyConstraints({\n    echoCancellation: true,\n    echoCancellationType: { ideal: \"system\" },\n    noiseSuppression: { ideal: true },\n  } as MediaTrackConstraints);\n  const dispose = () => {\n    track.stop();\n  };\n  return {\n    stream,\n    dispose,\n  };\n};\n","import { useCallback, useEffect, useState, useRef } from \"react\";\n\nimport { getFaceVideoStream } from \"../media/video\";\nimport { getAudioStream } from \"../media/audio\";\nimport { useRoomMedia } from \"./useRoom\";\n\nconst addTrackToStream = (\n  track: MediaStreamTrack,\n  stream: MediaStream | null,\n  disposeStream: (s: MediaStream) => void\n) => {\n  const newStream = stream || new MediaStream();\n  newStream.addTrack(track);\n  newStream.dispatchEvent(new MediaStreamTrackEvent(\"addtrack\", { track }));\n  track.addEventListener(\"ended\", () => {\n    newStream.removeTrack(track);\n    if (newStream.getTracks().length === 0) {\n      disposeStream(newStream);\n    }\n  });\n  return newStream;\n};\n\nexport const useFaceVideos = (\n  roomId: string,\n  userId: string,\n  videoEnabled: boolean,\n  audioEnabled: boolean,\n  micOn: boolean,\n  videoDeviceId?: string,\n  audioDeviceId?: string,\n  uniqueMediaId?: string\n) => {\n  const [faceStream, setFaceStream] = useState<MediaStream | null>(null);\n  const [faceStreamMap, setFaceStreamMap] = useState<{\n    [userId: string]: MediaStream;\n  }>({});\n\n  const isMounted = useRef(true);\n  useEffect(() => {\n    const cleanup = () => {\n      isMounted.current = false;\n    };\n    return cleanup;\n  }, []);\n\n  const onTrack = useCallback(async (track, info) => {\n    const disposeStream = (s: MediaStream) => {\n      if (isMounted.current) {\n        setFaceStreamMap((prev) => {\n          const { [info.userId]: oldStream, ...rest } = prev;\n          if (oldStream === s) {\n            return rest;\n          }\n          return prev;\n        });\n      }\n    };\n    setFaceStreamMap((prev) => {\n      const stream = prev[info.userId];\n      const newStream = addTrackToStream(track, stream, disposeStream);\n      if (stream === newStream) {\n        return prev;\n      }\n      return { ...prev, [info.userId]: newStream };\n    });\n  }, []);\n\n  const addVideoTrack = useRoomMedia(\n    roomId,\n    userId,\n    onTrack,\n    videoEnabled ? `${uniqueMediaId || \"face\"}Video` : undefined\n  );\n\n  const addAudioTrack = useRoomMedia(\n    roomId,\n    userId,\n    onTrack,\n    audioEnabled ? `${uniqueMediaId || \"face\"}Audio` : undefined\n  );\n\n  useEffect(() => {\n    let dispose: (() => void) | null = null;\n    if (videoEnabled && addVideoTrack) {\n      (async () => {\n        const {\n          stream: videoStream,\n          dispose: disposeVideo,\n        } = await getFaceVideoStream(videoDeviceId);\n        const [videoTrack] = videoStream.getVideoTracks();\n        const removeVideoTrack = addVideoTrack(videoTrack);\n        const disposeStream = (s: MediaStream) => {\n          if (isMounted.current) {\n            setFaceStream((prev) => (prev === s ? null : prev));\n          }\n        };\n        setFaceStream((prev) =>\n          addTrackToStream(videoTrack, prev, disposeStream)\n        );\n        dispose = () => {\n          removeVideoTrack();\n          disposeVideo();\n          // XXX we need to manually dispatch ended event, why?\n          videoTrack.dispatchEvent(new Event(\"ended\"));\n        };\n      })();\n    }\n    return () => {\n      if (dispose) dispose();\n    };\n  }, [roomId, videoEnabled, videoDeviceId, addVideoTrack]);\n\n  useEffect(() => {\n    let dispose: (() => void) | null = null;\n    if (audioEnabled && addAudioTrack) {\n      (async () => {\n        const {\n          stream: audioStream,\n          dispose: disposeAudio,\n        } = await getAudioStream(audioDeviceId);\n        const [audioTrack] = audioStream.getAudioTracks();\n        const removeAudioTrack = addAudioTrack(audioTrack);\n        const disposeStream = (s: MediaStream) => {\n          if (isMounted.current) {\n            setFaceStream((prev) => (prev === s ? null : prev));\n          }\n        };\n        setFaceStream((prev) =>\n          addTrackToStream(audioTrack, prev, disposeStream)\n        );\n        dispose = () => {\n          removeAudioTrack();\n          disposeAudio();\n          // XXX we need to manually dispatch ended event, why?\n          audioTrack.dispatchEvent(new Event(\"ended\"));\n        };\n      })();\n    }\n    return () => {\n      if (dispose) dispose();\n    };\n  }, [roomId, audioEnabled, audioDeviceId, addAudioTrack]);\n  useEffect(() => {\n    if (faceStream) {\n      faceStream.getAudioTracks().forEach((track) => {\n        const audioTrack = track;\n        audioTrack.enabled = micOn;\n      });\n      const onaddtrack = (event: MediaStreamTrackEvent) => {\n        const { track } = event;\n        if (track.kind === \"audio\") {\n          track.enabled = micOn;\n        }\n      };\n      faceStream.addEventListener(\"addtrack\", onaddtrack);\n      return () => {\n        faceStream.removeEventListener(\"addtrack\", onaddtrack);\n      };\n    }\n    return undefined;\n  }, [faceStream, micOn]);\n\n  return { faceStream, faceStreamMap };\n};\n","export const isObject = (x: unknown): x is Record<string, unknown> =>\n  typeof x === \"object\" && x !== null;\n\nexport const hasStringProp = <\n  Obj extends Record<string, unknown>,\n  Prop extends string\n>(\n  x: Obj,\n  prop: Prop\n): x is Obj & Record<Prop, string> =>\n  typeof (x as Record<Prop, unknown>)[prop] === \"string\";\n\nexport const hasObjectProp = <\n  Obj extends Record<string, unknown>,\n  Prop extends string\n>(\n  x: Obj,\n  prop: Prop\n): x is Obj & Record<Prop, Record<string, unknown>> =>\n  isObject((x as Record<Prop, unknown>)[prop]);\n\nexport type ReturnPromiseType<\n  F extends (...args: any) => any\n> = ReturnType<F> extends Promise<infer T> ? T : never;\n"],"sourceRoot":""}