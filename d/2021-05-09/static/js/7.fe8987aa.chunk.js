(this["webpackJsonpremote-faces-web"]=this["webpackJsonpremote-faces-web"]||[]).push([[7],{108:function(e,n,t){"use strict";t.d(n,"c",(function(){return r})),t.d(n,"b",(function(){return a})),t.d(n,"a",(function(){return c}));var r=function(e){return"object"===typeof e&&null!==e},a=function(e,n){return"string"===typeof e[n]},c=function(e,n){return r(e[n])}},144:function(e,n,t){"use strict";t.d(n,"a",(function(){return r}));var r=function(e){return new Promise((function(n){return setTimeout(n,e)}))}},1518:function(e,n,t){"use strict";t.d(n,"a",(function(){return a}));var r=0,a=function(){var e=new Map;return{setAcceptingMediaTypes:function(n,t){var r=e.get(n.peer);r&&(r.acceptingMediaTypes=t)},getAcceptingMediaTypes:function(n){var t=e.get(n.peer);return t?t.acceptingMediaTypes:[]},addConn:function(n,t){if(e.get(n))throw new Error("addConn: already exists");var a={peerIndex:r+=1,peer:n,userId:t,audioWorkers:new Map,vidoeSetImages:new Map};return e.set(a.peer,{conn:a,acceptingMediaTypes:[]}),a},getConn:function(n){var t=e.get(n);return t?t.conn:null},findConn:function(n){var t=Array.from(e.values()).find((function(e){return e.conn.peerIndex===n}));return t?t.conn:null},delConn:function(n){var t=e.get(n.peer);if(!t||t.conn!==n)throw new Error("delConn: does not exist");e.delete(n.peer)},getPeerIndexList:function(){return Array.from(e.values()).map((function(e){return e.conn.peerIndex}))},forEachConns:function(n){Array.from(e.values()).forEach((function(e){n(e.conn)}))},size:function(){return e.size}}}},189:function(e,n,t){"use strict";t.d(n,"c",(function(){return o})),t.d(n,"b",(function(){return i})),t.d(n,"d",(function(){return f})),t.d(n,"a",(function(){return d}));var r=t(4),a=t(2),c=t.n(a),u=t(3),s=new WeakMap,o=function(e,n){if(s.has(e))return e;s.set(e,!0);var t=function t(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3;if("ended"!==e.readyState){var a=n.getTransceivers().find((function(n){return n.receiver.track===e}));!a||"inactive"!==a.currentDirection&&"sendonly"!==a.currentDirection?r<64e3&&setTimeout((function(){t(2*r)}),r):(e.stop(),e.dispatchEvent(new Event("ended")))}};return e.addEventListener("mute",(function(){return t()})),e},i=function(e){return new Promise(function(){var n=Object(u.a)(c.a.mark((function n(t,r){var a,u,s,o;return c.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,a=new RTCPeerConnection,u=new RTCPeerConnection,a.addEventListener("icecandidate",(function(e){var n=e.candidate;n&&u.addIceCandidate(n)})),u.addEventListener("icecandidate",(function(e){var n=e.candidate;n&&a.addIceCandidate(n)})),u.addEventListener("track",(function(e){t(e.track)})),e.addEventListener("ended",(function(){a.close(),u.close()})),a.addTrack(e),n.next=10,a.createOffer();case 10:return s=n.sent,n.next=13,a.setLocalDescription(s);case 13:return n.next=15,u.setRemoteDescription(s);case 15:return n.next=17,u.createAnswer();case 17:return o=n.sent,n.next=20,u.setLocalDescription(o);case 20:return n.next=22,a.setRemoteDescription(o);case 22:n.next=27;break;case 24:n.prev=24,n.t0=n.catch(0),r(n.t0);case 27:case"end":return n.stop()}}),n,null,[[0,24]])})));return function(e,t){return n.apply(this,arguments)}}())},f=function(){var e=Object(u.a)(c.a.mark((function e(n){var t,r,a,s;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("video"===n.kind){e.next=2;break}throw new Error("track kind is not video");case 2:return t=document.createElement("canvas"),r=t.getContext("2d"),a=new ImageCapture(n),s=function(){var e=Object(u.a)(c.a.mark((function e(){var n;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,a.grabFrame();case 3:return n=e.sent,t.width=n.width,t.height=n.height,r.drawImage(n,0,0),e.abrupt("return",t.toDataURL("image/jpeg"));case 10:return e.prev=10,e.t0=e.catch(0),console.log("failed to grab frame from viedeo track",e.t0),e.abrupt("return",null);case 14:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(){return e.apply(this,arguments)}}(),e.abrupt("return",{getImage:s});case 7:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),p=function(e){return new Promise((function(n,t){var r=new Image;r.onload=function(){return n(r)},r.onerror=t,r.src=e}))},d=function(){var e=document.createElement("canvas"),n=e.getContext("2d"),t=e.captureStream().getVideoTracks();return{videoTrack:Object(r.a)(t,1)[0],setImage:function(){var t=Object(u.a)(c.a.mark((function t(r){var a;return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,p(r);case 2:a=t.sent,e.width=a.width,e.height=a.height,n.drawImage(a,0,0);case 6:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()}}},226:function(e,n){},232:function(e,n){},404:function(e,n){},407:function(e,n){},422:function(e,n){},425:function(e,n){},47:function(e,n,t){"use strict";t.r(n),function(e){t.d(n,"createRoom",(function(){return w}));var r=t(2),a=t.n(r),c=t(3),u=t(273),s=t(403),o=t.n(s),i=t(144),f=t(10),p=t(6),d=t(108),b=t(23),v=t(1518),x=t(189),l=new Map,h=function(){var e=Object(c.a)(a.a.mark((function e(n,t){var r,c;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r="".concat(n," ").concat(t),c=l.get(r)){e.next=7;break}return e.next=5,Object(f.k)(r);case 5:c=e.sent.slice(0,b.a),l.set(r,c);case 7:return e.abrupt("return",c);case 8:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),w=function(){var n=Object(c.a)(a.a.mark((function n(t,r,s,l,w,k){var m,y,g,O,j,I,E,T,C,M,A,S,N,D,W,L,P,R,_,V,z,J,B,F,G,U,Z,q,H,K,Q;return a.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return m=!1,y=Object(v.a)(),g=[],O=t.slice(0,b.a),n.next=7,Object(f.h)(t.slice(b.a));case 7:return j=n.sent,s({type:"INITIALIZING_PEER",peerIndex:0}),n.next=11,o.a.create({repo:Object(f.j)(),config:{Addresses:{Swarm:[Object(p.d)()||"/dns4/wrtc-star1.par.dwebops.pub/tcp/443/wss/p2p-webrtc-star/"]},Discovery:{MDNS:{Enabled:!0},webRTCStar:{Enabled:!0}}}});case 11:return I=n.sent,n.next=14,I.id();case 14:return E=n.sent.id,n.next=17,I.pubsub.subscribe(O,(function(e){return J(e)}));case 17:return n.next=19,I.pubsub.subscribe("".concat(O," ").concat(E),(function(e){return J(e)}));case 19:return T=function(){var e=Object(c.a)(a.a.mark((function e(n){var t,r;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Object(f.c)(n,j);case 3:if(null!==(t=e.sent)){e.next=6;break}return e.abrupt("return",void 0);case 6:return r=JSON.parse(t),console.log("decrypted payload",r),e.abrupt("return",r);case 11:return e.prev=11,e.t0=e.catch(0),console.info("Error in parsePayload",e.t0,n),e.abrupt("return",void 0);case 15:case"end":return e.stop()}}),e,null,[[0,11]])})));return function(n){return e.apply(this,arguments)}}(),C=function(){var n=Object(c.a)(a.a.mark((function n(t,r){var c,s,o,i,p,d,b;return a.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:n.prev=0,console.log("payload to encrypt",t,r),c=!0,s=!1,n.prev=4,i=Object(u.a)(Object(f.f)(JSON.stringify(r),j));case 6:return n.next=8,i.next();case 8:return p=n.sent,c=p.done,n.next=12,p.value;case 12:if(d=n.sent,c){n.next=20;break}return b=d,n.next=17,I.pubsub.publish(t,e.from(b),{});case 17:c=!0,n.next=6;break;case 20:n.next=26;break;case 22:n.prev=22,n.t0=n.catch(4),s=!0,o=n.t0;case 26:if(n.prev=26,n.prev=27,c||null==i.return){n.next=31;break}return n.next=31,i.return();case 31:if(n.prev=31,!s){n.next=34;break}throw o;case 34:return n.finish(31);case 35:return n.finish(26);case 36:n.next=41;break;case 38:n.prev=38,n.t1=n.catch(0),console.error("sendPayload",n.t1);case 41:case"end":return n.stop()}}),n,null,[[0,38],[4,22,26,36],[27,,31,35]])})));return function(e,t){return n.apply(this,arguments)}}(),M=function(){var e=Object(c.a)(a.a.mark((function e(n,t){var r;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r="".concat(O," ").concat(n.peer),e.next=3,C(r,t);case 3:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),A=function(){var e=Object(c.a)(a.a.mark((function e(n){var t;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!m){e.next=2;break}return e.abrupt("return");case 2:return t={userId:r,data:n,mediaTypes:g},e.next=5,C(O,t);case 5:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),S=function(){var e=Object(c.a)(a.a.mark((function e(n,t){var c,u;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!m){e.next=2;break}return e.abrupt("return");case 2:if(c=y.findConn(t)){e.next=5;break}return e.abrupt("return");case 5:return u={userId:r,data:n,mediaTypes:g},e.next=8,M(c,u);case 8:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),N=new Map,D=function(){var e=Object(c.a)(a.a.mark((function e(n){var r,u,s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=[],N.set(n,r),e.next=4,h(t,n);case 4:u=e.sent,s=function(){var e=Object(c.a)(a.a.mark((function e(t){var c,u,s,o,i,p,d,b,v,l;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.from!==E){e.next=2;break}return e.abrupt("return");case 2:if(c=y.getConn(t.from)){e.next=6;break}return console.warn("conn not ready"),e.abrupt("return");case 6:if(u={userId:c.userId,peerIndex:c.peerIndex,mediaTypes:y.getAcceptingMediaTypes(c)},c.audioWorkers.has(n)){e.next=24;break}return s=new AudioContext,o=s.createMediaStreamDestination(),i=0,p=0,(d=new Worker("audio-decoder.js",{type:"module"})).onmessage=function(e){var n=new Float32Array(e.data);p||(i=s.currentTime),i+=.06,p+=1;var t=s.createBuffer(1,2880,48e3);t.copyToChannel(n,0);var r=s.createBufferSource();r.buffer=t,r.connect(o),r.onended=function(){p-=1},r.start(i)},c.audioWorkers.set(n,d),b=o.stream.getAudioTracks()[0],e.t0=k,e.t1=n,e.next=20,Object(x.b)(b);case 20:e.t2=e.sent,e.t3=u,(0,e.t0)(e.t1,e.t2,e.t3),r.push((function(){s.close(),b.dispatchEvent(new Event("ended")),d.terminate(),c.audioWorkers.delete(n)}));case 24:return e.next=26,Object(f.a)(t.data.buffer,t.data.byteOffset,t.data.byteLength,j);case 26:v=e.sent,(l=c.audioWorkers.get(n))&&v.forEach((function(e){l.postMessage([e],[e])}));case 29:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),I.pubsub.subscribe(u,s),r.unshift((function(){I.pubsub.unsubscribe(u,s)}));case 8:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),W=function(){var e=Object(c.a)(a.a.mark((function e(n){var r,u,s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=[],N.set(n,r),e.next=4,h(t,n);case 4:u=e.sent,s=function(){var e=Object(c.a)(a.a.mark((function e(t){var c,u,s,o,i,p,d;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.from!==E){e.next=2;break}return e.abrupt("return");case 2:if(c=y.getConn(t.from)){e.next=6;break}return console.warn("conn not ready"),e.abrupt("return");case 6:return u={userId:c.userId,peerIndex:c.peerIndex,mediaTypes:y.getAcceptingMediaTypes(c)},c.vidoeSetImages.has(n)||(s=Object(x.a)(),o=s.videoTrack,i=s.setImage,c.vidoeSetImages.set(n,i),k(n,o,u),r.push((function(){o.dispatchEvent(new Event("ended")),c.vidoeSetImages.delete(n)}))),p=c.vidoeSetImages.get(n),e.prev=9,e.next=12,Object(f.c)(t.data,j);case 12:d=e.sent,p&&d&&p(d),e.next=19;break;case 16:e.prev=16,e.t0=e.catch(9),console.info("Error in parse for video media",e.t0);case 19:case"end":return e.stop()}}),e,null,[[9,16]])})));return function(n){return e.apply(this,arguments)}}(),I.pubsub.subscribe(u,s),r.unshift((function(){I.pubsub.unsubscribe(u,s)}));case 8:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),L=function(e){m||(N.forEach((function(n,t){e.includes(t)||(n.forEach((function(e){return e()})),N.delete(t))})),e.forEach((function(e){if(!N.has(e))if(e.endsWith("Audio"))D(e);else{if(!e.endsWith("Video"))throw new Error("pubsubRoom: cannot guess mediaType (Audio/Video)");W(e)}})),g=e,A(null))},P=function(){var e=Object(c.a)(a.a.mark((function e(n,t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:Array.isArray(t)&&t.every((function(e){return"string"===typeof e}))&&y.setAcceptingMediaTypes(n,t);case 1:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),R=function(e,n){var t={userId:e.userId,peerIndex:e.peerIndex,mediaTypes:y.getAcceptingMediaTypes(e)};try{w(n,t)}catch(r){console.warn("receiveData",r)}},_=function(){var e=Object(c.a)(a.a.mark((function e(n,t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,Object(d.c)(t)){e.next=3;break}return e.abrupt("return");case 3:P(n,t.mediaTypes),R(n,t.data),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),console.info("Error in handlePayload",e.t0,t);case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(n,t){return e.apply(this,arguments)}}(),V=function(e,n){var t=y.addConn(e,n);return l(t.peerIndex),s({type:"NEW_CONNECTION",peerIndex:t.peerIndex}),t},z=function(e){if(!Object(d.c)(e))return null;var n=e.userId;return"string"!==typeof n?null:n},J=function(){var e=Object(c.a)(a.a.mark((function e(n){var t,r,c,u;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!m){e.next=2;break}return e.abrupt("return");case 2:if(n.from!==E){e.next=4;break}return e.abrupt("return");case 4:return e.next=6,T(n.data);case 6:if(void 0!==(t=e.sent)){e.next=9;break}return e.abrupt("return");case 9:if(r=z(t),(c=y.getConn(n.from))||(r?c=V(n.from,r):console.warn("cannot initialize conn without user id")),!c){e.next=15;break}return e.next=15,_(c,t);case 15:u=y.getPeerIndexList(),s({type:"CONNECTED_PEERS",peerIndexList:u});case 17:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),(B=function(){var e=Object(c.a)(a.a.mark((function e(){var n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!m){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,I.pubsub.peers(O);case 4:if(n=e.sent,y.forEachConns((function(e){n.includes(e.peer)||(y.delConn(e),s({type:"CONNECTION_CLOSED",peerIndex:e.peerIndex}))})),n.length){e.next=12;break}return s({type:"CONNECTING_SEED_PEERS"}),e.next=10,Object(i.a)(1e3);case 10:return B(),e.abrupt("return");case 12:if(y.size()){e.next=15;break}return e.next=15,A(null);case 15:return e.next=17,Object(i.a)(5e3);case 17:B();case 18:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}())(),F=new WeakMap,G=function(e){e&&e()},U=function(){var n=Object(c.a)(a.a.mark((function n(r,u){var s,o,i,p,d,b;return a.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return G(F.get(u)),s=new MediaStream([u]),o=new AudioContext,i=o.createMediaStreamSource(s),n.next=6,o.audioWorklet.addModule("audio-encoder.js");case 6:return p=new AudioWorkletNode(o,"audio-encoder"),n.next=9,h(t,r);case 9:d=n.sent,b=[],p.port.onmessage=function(){var n=Object(c.a)(a.a.mark((function n(t){var r;return a.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(b.push(t.data),!(b.length<17)){n.next=3;break}return n.abrupt("return");case 3:return n.next=5,Object(f.d)(b.splice(0,b.length),j);case 5:r=n.sent,I.pubsub.publish(d,e.from(r),{});case 7:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}(),i.connect(p),F.set(u,(function(){o.close()}));case 14:case"end":return n.stop()}}),n)})));return function(e,t){return n.apply(this,arguments)}}(),Z=function(){var n=Object(c.a)(a.a.mark((function n(r,s){var o,p,d,b,v;return a.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return G(F.get(s)),n.next=3,h(t,r);case 3:return o=n.sent,n.next=6,Object(x.d)(s);case 6:p=n.sent,d=p.getImage,b=!1,(v=function(){var n=Object(c.a)(a.a.mark((function n(){var t,r,c,s,p,x,l,h;return a.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!b){n.next=2;break}return n.abrupt("return");case 2:return n.next=4,d();case 4:if(!(t=n.sent)){n.next=46;break}r=!0,c=!1,n.prev=8,p=Object(u.a)(Object(f.f)(t,j));case 10:return n.next=12,p.next();case 12:return x=n.sent,r=x.done,n.next=16,x.value;case 16:if(l=n.sent,r){n.next=28;break}if(h=l,!b){n.next=21;break}return n.abrupt("return");case 21:return n.next=23,I.pubsub.publish(o,e.from(h),{});case 23:return n.next=25,Object(i.a)(1e3);case 25:r=!0,n.next=10;break;case 28:n.next=34;break;case 30:n.prev=30,n.t0=n.catch(8),c=!0,s=n.t0;case 34:if(n.prev=34,n.prev=35,r||null==p.return){n.next=39;break}return n.next=39,p.return();case 39:if(n.prev=39,!c){n.next=42;break}throw s;case 42:return n.finish(39);case 43:return n.finish(34);case 44:n.next=48;break;case 46:return n.next=48,Object(i.a)(5e3);case 48:v();case 49:case"end":return n.stop()}}),n,null,[[8,30,34,44],[35,,39,43]])})));return function(){return n.apply(this,arguments)}}())(),F.set(s,(function(){b=!0}));case 12:case"end":return n.stop()}}),n)})));return function(e,t){return n.apply(this,arguments)}}(),q=new Map,H=function(){var e=Object(c.a)(a.a.mark((function e(n,t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!m){e.next=2;break}return e.abrupt("return");case 2:if(!q.has(n)){e.next=4;break}throw new Error("track is already added for ".concat(n));case 4:if(q.set(n,t),!n.endsWith("Audio")){e.next=9;break}U(n,t),e.next=14;break;case 9:if(!n.endsWith("Video")){e.next=13;break}Z(n,t),e.next=14;break;case 13:throw new Error("pubsubRoom: cannot guess mediaType (Audio/Video)");case 14:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),K=function(e){if(!m){var n=q.get(e);n?(q.delete(e),G(F.get(n))):console.log("track is already removed for",e)}},Q=function(){var e=Object(c.a)(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return m=!0,e.next=3,I.pubsub.unsubscribe("".concat(O," ").concat(E),J);case 3:return e.next=5,I.pubsub.unsubscribe(O,J);case 5:return e.next=7,I.stop();case 7:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),n.abrupt("return",{broadcastData:A,sendData:S,acceptMediaTypes:L,addTrack:H,removeTrack:K,dispose:Q});case 47:case"end":return n.stop()}}),n)})));return function(e,t,r,a,c,u){return n.apply(this,arguments)}}()}.call(this,t(62).Buffer)},474:function(e,n){},475:function(e,n){},508:function(e,n){},522:function(e,n){},527:function(e,n){},528:function(e,n){},561:function(e,n){},575:function(e,n){},582:function(e,n){},583:function(e,n){},605:function(e,n){}}]);
//# sourceMappingURL=7.fe8987aa.chunk.js.map