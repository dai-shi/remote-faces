(self.webpackChunkremote_faces_web=self.webpackChunkremote_faces_web||[]).push([[729],{33413:(e,n,t)=>{"use strict";t.r(n),t.d(n,{createRoom:()=>u});var r=t(28326),o=t.n(r),c=t(93057),i=t(65954),a=t(1239),s=t(50634),d=t(76996);const l=(e,n)=>`${e.slice(0,d.W)} ${n}`,p=e=>Number(e.split(" ")[1]),g=e=>p(e.peer);var f=t(52780);const u=async(e,n,t,r,u,y)=>{let m=!1;const C=(()=>{const e=new Map,n=e=>!!(e&&e.connected&&e.conn.open),t=(n,t,r)=>{const o=e.get(n.peer);if(!o)return;let c;r.split(/[\r\n]+/).forEach((e=>{e.startsWith("a=mid:")?c=e.slice("a=mid:".length):e.startsWith("a=msid:")&&e.slice("a=msid:".length).split(" ").forEach((e=>{const n=t[e];"string"===typeof n&&(o.remoteMediaTypes[c]=n)}))}))};return{setAcceptingMediaTypes:(n,t)=>{const r=e.get(n.peer);r&&(r.acceptingMediaTypes=t)},getAcceptingMediaTypes:n=>{const t=e.get(n.peer);return t?t.acceptingMediaTypes:[]},addConn:n=>{const t=e.get(n.peer);e.set(n.peer,{conn:n,createdAt:Date.now(),acceptingMediaTypes:[],remoteMediaTypes:{}}),t&&t.conn.close()},markConnected:n=>{const t=e.get(n.peer);t&&t.conn===n&&(t.connected=!0)},isConnectedPeerId:t=>n(e.get(t)),isConnectedConn:t=>{const r=e.get(t.peer);return!(!r||r.conn!==t)&&n(r)},setUserId:(n,t)=>{const r=e.get(n.peer);r&&(r.userId=t)},getUserId:n=>{const t=e.get(n.peer);return t&&t.userId},hasFreshConn:n=>{const t=e.get(n);return!!t&&t.createdAt>Date.now()-6e5},getConn:n=>{const t=e.get(n);return t?t.conn:null},delConn:n=>{const t=e.get(n.peer);return!(!t||t.conn!==n)&&(e.delete(n.peer),!0)},getConnectedPeerIds:()=>Array.from(e.keys()).filter((t=>n(e.get(t)))),getNotConnectedPeerIds:()=>Array.from(e.keys()).filter((t=>!n(e.get(t)))),forEachConnectedConns:t=>{Array.from(e.values()).forEach((e=>{n(e)&&t(e.conn)}))},forEachConnsAcceptingMedia:(t,r)=>{Array.from(e.values()).forEach((e=>{n(e)&&e.acceptingMediaTypes.includes(t)&&r(e.conn)}))},clearAll:()=>{e.size&&console.log("connectionMap garbage:",[...e.entries()].map((e=>{let[n,t]=e;return{id:n,createdAt:t.createdAt,connected:t.connected,open:t.conn.open,userId:t.userId}}))),e.clear()},getRemoteMediaType:(n,t)=>{const r=e.get(n.peer);return r&&r.remoteMediaTypes[t]||null},registerRemoteMediaType:(e,n)=>{(0,s.Hk)(n,"msid2mediaType")&&((0,s.Hk)(n,"offer")&&(0,s.wH)(n.offer,"sdp")&&t(e,n.msid2mediaType,n.offer.sdp),(0,s.Hk)(n,"answer")&&(0,s.wH)(n.answer,"sdp")&&t(e,n.msid2mediaType,n.answer.sdp))}}})();window.myConnMap=C;let w=[];const v=await(0,i.I1)(e.slice(d.W));let h=null;window.getMyPeer=()=>h;const T=function(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;if(m)return;C.clearAll(),t({type:"INITIALIZING_PEER",peerIndex:n});const r=l(e,n),c=new(o())(r,(0,a.sR)());c.on("open",(()=>{h=c,t({type:"CONNECTING_SEED_PEERS"}),setTimeout(k,10)})),c.on("error",(e=>{if("unavailable-id"===e.type){if(c.destroy(),50===n)throw new Error("max peer index reached");setTimeout((()=>{T(n+1)}),100)}else"peer-unavailable"===e.type||("disconnected"===e.type?console.log("initMyPeer disconnected error",n,e):"network"===e.type?(console.log("initMyPeer network error",n,e),setTimeout((()=>{c.destroyed||null!==h||(c.destroy(),T())}),1e4)):"server-error"===e.type?(console.log("initMyPeer server error",n,e),t({type:"SERVER_ERROR"})):(console.error("initMyPeer unknown error",n,e.type,e),t({type:"UNKNOWN_ERROR",err:e})))})),c.on("connection",(e=>c!==h?(console.log("new connection to old peer, closing"),void e.close()):c.id===e.peer?(console.log("new connection from self, closing"),void e.close()):(t({type:"NEW_CONNECTION",peerIndex:g(e)}),void D(e)))),c.on("disconnected",(()=>{console.log("initMyPeer disconnected",n),setTimeout((()=>{c.destroyed||c!==h||(t({type:"RECONNECTING",peerIndex:n}),c.reconnect(),setTimeout((()=>{c.disconnected&&!c.destroyed&&c===h&&(console.log("reconnect failed, re-initializing"),c.destroy(),h=null,T())}),6e4))}),5e3)}))};T();const E=()=>{var e;if(m)return;const n=C.getConnectedPeerIds().map(p);t({type:"CONNECTED_PEERS",peerIndexList:n}),console.log("myPeer index:",(null===(e=h)||void 0===e?void 0:e.id)&&p(h.id),", connecting:",C.getNotConnectedPeerIds().map(p))},k=()=>{if(!h)return;const n=p(h.id);if(n>1)for(let t=1;t<n;t+=1){const n=l(e,t);I(n)}else{const t=n=>{if(n>50)return;if(C.getConnectedPeerIds().length>0)return;const r=l(e,n);I(r),setTimeout((()=>{t(n+1)}),1e3)};t(n+1)}},I=e=>{if(m||!h)return;if(h.id===e||h.disconnected)return;if(C.isConnectedPeerId(e))return;if(C.hasFreshConn(e))return;console.log("connectPeer",e);const n=h.connect(e);D(n)},M=e=>{if(m)return;const t=C.getConnectedPeerIds();C.forEachConnectedConns((r=>{R(r,{userId:n,data:e,peers:t,mediaTypes:w})}))},P=(e,n)=>{const t=x();R(e,{SDP:{...n,msid2mediaType:t}})},A=n=>{Array.isArray(n)&&n.forEach((n=>{((e,n)=>"string"===typeof n&&n.startsWith(`${e.slice(0,d.W)} `))(e,n)&&I(n)}))},N=async(e,n)=>{if(!m)try{const t=JSON.parse(await(0,i.NA)(n,v));if(!(0,s.Kn)(t))return;(async(e,n)=>{if((0,s.Kn)(n))if(C.registerRemoteMediaType(e,n),(0,s.Hk)(n,"offer"))try{await e.peerConnection.setRemoteDescription(n.offer),L(e);const t=await e.peerConnection.createAnswer();await e.peerConnection.setLocalDescription(t),P(e,{answer:t})}catch(t){console.info("handleSDP offer failed",t)}else if((0,s.Hk)(n,"answer"))try{await e.peerConnection.setRemoteDescription(n.answer)}catch(t){console.info("handleSDP answer failed",t),await(0,c._)(30*Math.random()*1e3),_(e),L(e)}else console.warn("unknown SDP",n)})(e,t.SDP),((e,n)=>{"string"===typeof n&&C.setUserId(e,n)})(e,t.userId),(async(e,n)=>{Array.isArray(n)&&n.every((e=>"string"===typeof e))&&(C.setAcceptingMediaTypes(e,n),await(0,c._)(5e3),L(e))})(e,t.mediaTypes),A(t.peers),((e,n)=>{const t=C.getUserId(e);if(t){const o={userId:t,peerIndex:g(e),mediaTypes:C.getAcceptingMediaTypes(e)};try{u(n,o)}catch(r){console.warn("receiveData",r)}}})(e,t.data)}catch(t){console.info("Error in handlePayload",t,n)}},R=async(e,n)=>{try{const t=await(0,i.Wu)(JSON.stringify(n),v);e.send(t)}catch(t){console.error("sendPayload",t)}},D=e=>{let n;C.isConnectedPeerId(e.peer)&&console.info("dataConnection already in map, overriding",e.peer),C.addConn(e);const o=()=>{clearTimeout(n),n=setTimeout((()=>{const n=g(e);console.log("dataConnection inactive for 5min",n,e.open),e.open||C.delConn(e),e.close()}),3e5)};o(),e.on("open",(()=>{o(),C.markConnected(e);const n=g(e);console.log("dataConnection open",n),E(),r(n)})),e.on("data",(n=>{o(),C.markConnected(e),N(e,n)})),e.peerConnection.addEventListener("icegatheringstatechange",(()=>{const n=e.peerConnection;"complete"===n.iceGatheringState&&(n.onicecandidate=()=>{})}));let i=!1;e.peerConnection.addEventListener("negotiationneeded",(async()=>{if(i)return;if(i=!0,await(0,c._)(5e3),i=!1,!C.isConnectedConn(e))return;if(!e.peerConnection)return;if("closed"===e.peerConnection.signalingState)return;const n=await e.peerConnection.createOffer();await e.peerConnection.setLocalDescription(n),P(e,{offer:n})})),e.peerConnection.addEventListener("track",(n=>{if(!C.isConnectedConn(e))return void console.warn("received track from non-connected peer, ignoring");const{mid:t}=n.transceiver,r=t&&C.getRemoteMediaType(e,t);if(!r)return void console.warn("failed to find media type from mid");const o=C.getUserId(e);if(o){const t={userId:o,peerIndex:p(e.peer),mediaTypes:C.getAcceptingMediaTypes(e)};y(r,(0,f.xm)(n.track,e.peerConnection),t)}})),e.on("close",(()=>{if(clearTimeout(n),!C.delConn(e))return;const r=g(e);t({type:"CONNECTION_CLOSED",peerIndex:r}),E(),0===C.getConnectedPeerIds().length&&S()}))},S=()=>{h&&!h.disconnected&&(h.destroy(),h=null,T())},O=new Map,x=()=>{const e={};return O.forEach(((n,t)=>{let{stream:r}=n;e[r.id]=t})),e},L=e=>{var n,t;const r=null!==(n=null===(t=e.peerConnection)||void 0===t?void 0:t.getSenders())&&void 0!==n?n:[],o=C.getAcceptingMediaTypes(e);o.forEach((n=>{const t=O.get(n);if(!t)return;const{stream:o,track:c}=t;r.every((e=>e.track!==c))&&e.peerConnection.addTrack(c,o)})),r.forEach((n=>{if(!n.track)return;o.some((e=>{var t;return(null===(t=O.get(e))||void 0===t?void 0:t.track)===n.track}))||"closed"===e.peerConnection.signalingState||e.peerConnection.removeTrack(n)})),r.some((e=>e.track&&!e.transport))&&e.peerConnection.dispatchEvent(new Event("negotiationneeded"))},_=e=>{var n,t;(null!==(n=null===(t=e.peerConnection)||void 0===t?void 0:t.getSenders())&&void 0!==n?n:[]).forEach((n=>{n.track&&"closed"!==e.peerConnection.signalingState&&e.peerConnection.removeTrack(n)}))};return{broadcastData:M,sendData:(t,r)=>{if(m)return;const o=C.getConn(l(e,r));if(!o)return;const c=C.getConnectedPeerIds();R(o,{userId:n,data:t,peers:c,mediaTypes:w})},acceptMediaTypes:e=>{m||(e.length!==w.length&&C.forEachConnectedConns((n=>{const t=C.getUserId(n);if(t){const r={userId:t,peerIndex:p(n.peer),mediaTypes:C.getAcceptingMediaTypes(n)},o=n.peerConnection.getTransceivers();n.peerConnection.getReceivers().forEach((t=>{const c=o.find((e=>e.receiver===t)),i=null===c||void 0===c?void 0:c.mid,a=i&&C.getRemoteMediaType(n,i);a?"live"===t.track.readyState&&!w.includes(a)&&e.includes(a)&&y(a,(0,f.xm)(t.track,n.peerConnection),r):console.warn("failed to find media type from mid")}))}})),w=e,M(null))},addTrack:(e,n)=>{if(m)return;if(O.has(e))throw new Error(`track is already added for ${e}`);const t=new MediaStream([n]);O.set(e,{stream:t,track:n}),C.forEachConnsAcceptingMedia(e,(e=>{try{e.peerConnection.addTrack(n,t)}catch(r){if("InvalidAccessError"!==r.name)throw r}}))},removeTrack:e=>{if(m)return;const n=O.get(e);if(!n)return void console.log("track is already removed for",e);const{track:t}=n;O.delete(e),C.forEachConnsAcceptingMedia(e,(e=>{var n,r;const o=(null!==(n=null===(r=e.peerConnection)||void 0===r?void 0:r.getSenders())&&void 0!==n?n:[]).find((e=>e.track===t));o&&"closed"!==e.peerConnection.signalingState&&e.peerConnection.removeTrack(o)}))},dispose:()=>{m=!0,h&&(h.destroy(),h=null)}}}},52780:(e,n,t)=>{"use strict";t.d(n,{xm:()=>o,sW:()=>c,gG:()=>i,FX:()=>a});const r=new WeakMap,o=(e,n)=>{if(r.has(e))return e;r.set(e,!0);const t=function(){let r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3;if("ended"===e.readyState)return;const o=n.getTransceivers().find((n=>n.receiver.track===e));!o||"inactive"!==o.currentDirection&&"sendonly"!==o.currentDirection?r<64e3&&setTimeout((()=>{t(2*r)}),r):(e.stop(),e.dispatchEvent(new Event("ended")))};return e.addEventListener("mute",(()=>t())),e},c=e=>new Promise((async(n,t)=>{try{const t=new RTCPeerConnection,r=new RTCPeerConnection;t.addEventListener("icecandidate",(e=>{let{candidate:n}=e;n&&r.addIceCandidate(n)})),r.addEventListener("icecandidate",(e=>{let{candidate:n}=e;n&&t.addIceCandidate(n)})),r.addEventListener("track",(e=>{n(e.track)})),e.addEventListener("ended",(()=>{t.close(),r.close()})),t.addTrack(e);const o=await t.createOffer();await t.setLocalDescription(o),await r.setRemoteDescription(o);const c=await r.createAnswer();await r.setLocalDescription(c),await t.setRemoteDescription(c)}catch(r){t(r)}})),i=async e=>{if("video"!==e.kind)throw new Error("track kind is not video");const n=document.createElement("canvas"),t=n.getContext("2d"),r=new ImageCapture(e);return{getImage:async()=>{try{const e=await r.grabFrame();return n.width=e.width,n.height=e.height,t.drawImage(e,0,0),n.toDataURL("image/jpeg")}catch(e){return console.log("failed to grab frame from viedeo track",e),null}}}},a=()=>{const e=document.createElement("canvas"),n=e.getContext("2d"),t=e.captureStream(),[r]=t.getVideoTracks();return{videoTrack:r,setImage:async t=>{const r=await(o=t,new Promise(((e,n)=>{const t=new Image;t.onload=()=>e(t),t.onerror=n,t.src=o})));var o;e.width=r.width,e.height=r.height,n.drawImage(r,0,0)}}}},98983:e=>{function n(e){var n=new Error("Cannot find module '"+e+"'");throw n.code="MODULE_NOT_FOUND",n}n.keys=()=>[],n.resolve=n,n.id=98983,e.exports=n}}]);
//# sourceMappingURL=729.3ae8c857.chunk.js.map