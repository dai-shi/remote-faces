{"version":3,"sources":["hooks/useMomentaryChat.ts","components/WysiwygEditor.tsx","components/MomentaryChat.tsx","hooks/useNotification.ts"],"names":["isReply","x","Array","isArray","length","isChatItem","isObject","nickname","messageId","createdAt","text","every","isReplies","replies","compareReply","a","b","countDiff","config","toolbar","balloonToolbar","link","addTargetToExternalLinks","WysiwygEditor","React","memo","registerClear","onChange","onMetaEnter","editor","CustomEditor","onReady","sourceElement","addEventListener","event","metaKey","code","setData","plugins","get","addItems","title","character","initEditor","_event","data","getData","MAX_CHAT_TEXT_SIZE","getChatTime","item","Date","toLocaleString","split","slice","MomentaryChatContentPart","replyChat","useState","openEmojiPicker","setOpenEmojiPicker","reply","className","onSelect","e","native","style","width","type","onClick","dangerouslySetInnerHTML","__html","DOMPurify","sanitize","ADD_ATTR","map","count","MomentaryChatContent","chatList","chatListRef","useRef","latestMessageId","useEffect","current","scrollTop","scrollHeight","ref","MomentaryChat","roomId","userId","uniqueId","containerRef","uniqueChatId","chatType","setChatList","list","getRoomState","ydoc","getArray","listener","toArray","filter","observe","unobserve","sendChat","useCallback","chatItem","secureRandomId","now","unshift","delete","inReplyTo","forEach","index","replyMap","Map","set","entries","sort","insert","useMomentaryChat","clearRef","canSend","setCanSend","textRef","setText","t","sendText","sendNotification","notificationRef","mesg","Notification","permission","close","requestPermission","useNotification","latestChatItem","RegExp","test","clear","disabled"],"mappings":"2UAUMA,EAAU,SAACC,GAAD,OACdC,MAAMC,QAAQF,IACD,IAAbA,EAAEG,QACc,kBAATH,EAAE,IACO,kBAATA,EAAE,IAaLI,EAAa,SAACJ,GAAD,OACjBK,YAASL,IACwC,kBAAzCA,EAA4BM,UACe,kBAA3CN,EAA6BO,WACc,kBAA3CP,EAA6BQ,WACI,kBAAjCR,EAAwBS,MAhBhB,SAACT,GAAD,OAChBC,MAAMC,QAAQF,IAAMA,EAAEU,MAAMX,GAgB5BY,CAAWX,EAA2BY,UAElCC,EAAe,SAACC,EAAUC,GAC9B,IAAMC,EAAYD,EAAE,GAAKD,EAAE,GAC3B,OAAkB,IAAdE,EACKF,EAAE,GAAGX,OAASY,EAAE,GAAGZ,OAErBa,G,sCChCHC,G,QAAS,CACbC,QAAS,CACP,oBACA,IACA,OACA,SACA,OACA,aACA,IACA,cACA,cACA,aACA,IACA,OACA,QAEFC,eAAgB,CACd,UACA,IACA,eACA,eACA,SACA,WAEFC,KAAM,CACJC,0BAA0B,KAcjBC,EAAgBC,IAAMC,MAIhC,gBAAGC,EAAH,EAAGA,cAAeC,EAAlB,EAAkBA,SAAUC,EAA5B,EAA4BA,YAA5B,OACD,cAAC,WAAD,CACEC,OAAQC,IACRZ,OAAQA,EACRa,QAAS,SAACF,GAMRA,EAAOG,cAAcC,iBAAiB,WALpB,SAACC,GACbA,EAAMC,SAA0B,UAAfD,EAAME,MACzBR,OAIJF,GAAc,WACZG,EAAOQ,QAAQ,OA1BJ,SAACR,GAClBA,EAAOS,QAAQC,IAAI,qBAAqBC,SAAS,QAAS,CACxD,CAAEC,MAAO,cAAeC,UAAW,gBACnC,CAAED,MAAO,SAAUC,UAAW,gBAC9B,CAAED,MAAO,oBAAqBC,UAAW,sBACzC,CAAED,MAAO,cAAeC,UAAW,gBACnC,CAAED,MAAO,QAASC,UAAW,kBAsB3BC,CAAWd,IAEbF,SAAU,SAACiB,EAAQf,GACjB,IAAMgB,EAAOhB,EAAOiB,UACpBnB,EAASkB,SC5DTE,EAAqB,QASrBC,EAAc,SAACC,GAAD,OAClB,IAAIC,KAAKD,EAAKxC,WAAW0C,iBAAiBC,MAAM,KAAK,GAAGC,MAAM,GAAI,IAE9DC,EAA2B9B,IAAMC,MAGpC,YAA0B,IAVXf,EAUZuC,EAAsB,EAAtBA,KAAMM,EAAgB,EAAhBA,UAAgB,EACoBC,oBAAS,GAD7B,mBACnBC,EADmB,KACFC,EADE,KAEpBC,EAAQ,SAACjD,GAAD,OAAkB6C,EAAU7C,EAAMuC,EAAKzC,YACrD,OACE,qBAAyBoD,UAAU,yBAAnC,UACGH,GACC,cAAC,IAAD,CACEI,SAAU,SAACC,GACTH,EAAMG,EAAEC,QACRL,GAAmB,IAErBM,MAAO,CAAEC,MAAO,UAGpB,sBAAKL,UAAU,gCAAf,UACE,qBAAKA,UAAU,qCAAf,SACE,qBAAKA,UAAU,2BAAf,SACE,wBACEM,KAAK,SACLC,QAAS,WACPT,GAAoBD,IAHxB,mBAUJ,sBAAMG,UAAU,yBAAhB,SACGX,EAAK1C,UAAY,YAEpB,sBAAMqD,UAAU,qBAAhB,SAAsCZ,EAAYC,QAEpD,qBACEW,UAAU,gCACVQ,yBA5CU1D,EA4CwBuC,EAAKvC,KA5CX,CAClC2D,OAAQC,IAAUC,SAAS7D,EAAM,CAAE8D,SAAU,CAAC,iBA6CxCvB,EAAKpC,SAAW,IAAI4D,KAAI,mCAAE/D,EAAF,KAAQgE,EAAR,YACxB,yBAEEd,UAAU,qBACVM,KAAK,SACLC,QAAS,kBAAMR,EAAMjD,IAJvB,UAMGA,EANH,IAMUgE,IALHhE,QAlCFuC,EAAKzC,cA8CZmE,EAAuBnD,IAAMC,MAGhC,YAA8B,IAAD,EAA1BmD,EAA0B,EAA1BA,SAAUrB,EAAgB,EAAhBA,UACRsB,EAAcC,iBAAgC,MAC9CC,EAAe,UAAGH,EAAS,UAAZ,aAAG,EAAapE,UAOrC,OANAwE,qBAAU,WACJH,EAAYI,SAAWF,IACzBF,EAAYI,QAAQC,UAAYL,EAAYI,QAAQE,gBAErD,CAACJ,IAGF,oBAAInB,UAAU,qBAAqBwB,IAAKP,EAAxC,SACGD,EAASH,KAAI,SAACxB,GAAD,OACZ,cAACK,EAAD,CAEEL,KAAMA,EACNM,UAAWA,GAFNN,EAAKzC,mBASP6E,EAAgB7D,IAAMC,MAKhC,YAA6C,IAA1C6D,EAAyC,EAAzCA,OAAQC,EAAiC,EAAjCA,OAAQhF,EAAyB,EAAzBA,SAAUiF,EAAe,EAAfA,SACxBC,EAAeX,iBAA8B,MADN,EF7Df,SAC9BQ,EACAC,EACAhF,EACAmF,GAEA,IAAMC,EAAQ,UAAMD,GAAgB,YAAtB,QADX,EAE6BlC,mBAAqB,IAFlD,mBAEIoB,EAFJ,KAEcgB,EAFd,KAyDH,OArDAZ,qBAAU,WACR,IACMa,EADYC,YAAaR,EAAQC,GAChBQ,KAAKC,SAASL,GAC/BM,EAAW,WACfL,EAAYC,EAAKK,UAAUC,OAAO9F,KAIpC,OAFAwF,EAAKO,QAAQH,GACbA,IACO,WACLJ,EAAKQ,UAAUJ,MAEhB,CAACX,EAAQC,EAAQI,IA0Cb,CACLf,WACA0B,SA1CeC,uBACf,SAAC7F,GACC,IACMmF,EADYC,YAAaR,EAAQC,GAChBQ,KAAKC,SAASL,GAC/Ba,EAAqB,CACzBjG,WACAC,UAAWiG,cACXhG,UAAWyC,KAAKwD,MAChBhG,OACAG,QAAS,IAEXgF,EAAKc,QAAQ,CAACH,IACVX,EAAKzF,OAvEY,KAwEnByF,EAAKe,OAAOf,EAAKzF,OAAS,EAAG,GAE/BwF,EAAYC,EAAKK,UAAUC,OAAO9F,MAEpC,CAACiF,EAAQC,EAAQhF,EAAUoF,IA0B3BpC,UAvBgBgD,uBAChB,SAAC7F,EAAcmG,GACb,IACMhB,EADYC,YAAaR,EAAQC,GAChBQ,KAAKC,SAASL,GACrCE,EAAKiB,SAAQ,SAAC7D,EAAM8D,GAClB,GAAK1G,EAAW4C,IACZA,EAAKzC,YAAcqG,EAAW,CAChC,IAAMG,EAAW,IAAIC,IAAIhE,EAAKpC,SAC9BmG,EAASE,IAAIxG,GAAOsG,EAASzE,IAAI7B,IAAS,GAAK,GAC/C,IAAMG,EAAO,YAAOmG,EAASG,WAC7BtG,EAAQuG,KAAKtG,GACb+E,EAAKe,OAAOG,EAAO,GACnBlB,EAAKwB,OAAON,EAAO,CAAC,2BAAK9D,GAAN,IAAYpC,kBAGnC+E,EAAYC,EAAKK,UAAUC,OAAO9F,MAEpC,CAACiF,EAAQC,EAAQI,KEIuB2B,CACxChC,EACAC,EACAhF,EACAiF,GAJMZ,EAFqC,EAErCA,SAAU0B,EAF2B,EAE3BA,SAAU/C,EAFiB,EAEjBA,UAOtBgE,EAAWzC,mBAT4B,EAcftB,oBAAS,GAdM,mBActCgE,EAdsC,KAc7BC,EAd6B,KAevCC,EAAU5C,iBAAO,IACjB6C,EAAUpB,uBAAY,SAACqB,GAC3BF,EAAQzC,QAAU2C,EAClBH,IAAaG,GAAKA,EAAExH,QAAU2C,KAC7B,IACG8E,EAAWtB,uBAAY,WACvBmB,EAAQzC,SAAWyC,EAAQzC,QAAQ7E,QAAU2C,IAC/CuD,EAASoB,EAAQzC,SACjB0C,EAAQ,IACJJ,EAAStC,SACXsC,EAAStC,aAGZ,CAACqB,EAAUqB,IAERG,ECpIuB,WAC7B,IAAMC,EAAkBjD,mBAClBgD,EAAmBvB,uBAAY,SAACyB,GACJ,YAA5BC,aAAaC,aACXH,EAAgB9C,SAClB8C,EAAgB9C,QAAQkD,QAE1BJ,EAAgB9C,QAAU,IAAIgD,aAAaD,MAE5C,IAMH,OALAhD,qBAAU,WACwB,YAA5BiD,aAAaC,YACfD,aAAaG,sBAEd,IACIN,EDqHkBO,GACnBC,EAAiB1D,EAAS,GAWhC,OAVAI,qBAAU,WAENsD,GACAA,EAAe7H,UAAYyC,KAAKwD,MAAQ,KACxC,IAAI6B,OAAJ,WAAehI,EAAf,QAA8BiI,KAAKF,EAAe5H,OAElDoH,EAAiB,4BAElB,CAACvH,EAAU+H,EAAgBR,IAG5B,sBAAKlE,UAAU,0BAA0BwB,IAAKK,EAA9C,UACE,cAACd,EAAD,CAAsBC,SAAUA,EAAUrB,UAAWA,IACrD,qBAAKK,UAAU,uBAAf,SACE,cAAC,EAAD,CACElC,cArCc,SAAC+G,GACrBlB,EAAStC,QAAUwD,GAqCb9G,SAAUgG,EACV/F,YAAaiG,MAGjB,qBAAKjE,UAAU,uBAAf,SACE,wBAAQM,KAAK,SAASC,QAAS0D,EAAUa,UAAWlB,EAApD,0BAQOnC","file":"static/js/11.948ddc52.chunk.js","sourcesContent":["import { useState, useCallback, useEffect } from \"react\";\n\nimport { secureRandomId } from \"../utils/crypto\";\nimport { isObject } from \"../utils/types\";\nimport { getRoomState } from \"../states/roomMap\";\n\nconst MAX_CHAT_LIST_SIZE = 100;\n\ntype Reply = [string, number];\n\nconst isReply = (x: unknown): x is Reply =>\n  Array.isArray(x) &&\n  x.length === 2 &&\n  typeof x[0] === \"string\" &&\n  typeof x[1] === \"number\";\n\nconst isReplies = (x: unknown): x is Reply[] =>\n  Array.isArray(x) && x.every(isReply);\n\nexport type ChatItem = {\n  nickname: string;\n  messageId: string;\n  createdAt: number; // in millisecond\n  text: string;\n  replies: Reply[];\n};\n\nconst isChatItem = (x: unknown): x is ChatItem =>\n  isObject(x) &&\n  typeof (x as { nickname: unknown }).nickname === \"string\" &&\n  typeof (x as { messageId: unknown }).messageId === \"string\" &&\n  typeof (x as { createdAt: unknown }).createdAt === \"number\" &&\n  typeof (x as { text: unknown }).text === \"string\" &&\n  isReplies((x as { replies: unknown }).replies);\n\nconst compareReply = (a: Reply, b: Reply) => {\n  const countDiff = b[1] - a[1];\n  if (countDiff === 0) {\n    return a[0].length - b[0].length;\n  }\n  return countDiff;\n};\n\nexport const useMomentaryChat = (\n  roomId: string,\n  userId: string,\n  nickname: string,\n  uniqueChatId?: string\n) => {\n  const chatType = `${uniqueChatId || \"momentray\"}Chat`;\n  const [chatList, setChatList] = useState<ChatItem[]>([]);\n\n  useEffect(() => {\n    const roomState = getRoomState(roomId, userId);\n    const list = roomState.ydoc.getArray(chatType);\n    const listener = () => {\n      setChatList(list.toArray().filter(isChatItem));\n    };\n    list.observe(listener);\n    listener();\n    return () => {\n      list.unobserve(listener);\n    };\n  }, [roomId, userId, chatType]);\n\n  const sendChat = useCallback(\n    (text: string) => {\n      const roomState = getRoomState(roomId, userId);\n      const list = roomState.ydoc.getArray(chatType);\n      const chatItem: ChatItem = {\n        nickname,\n        messageId: secureRandomId(),\n        createdAt: Date.now(),\n        text,\n        replies: [],\n      };\n      list.unshift([chatItem]);\n      if (list.length > MAX_CHAT_LIST_SIZE) {\n        list.delete(list.length - 1, 1);\n      }\n      setChatList(list.toArray().filter(isChatItem));\n    },\n    [roomId, userId, nickname, chatType]\n  );\n\n  const replyChat = useCallback(\n    (text: string, inReplyTo: string) => {\n      const roomState = getRoomState(roomId, userId);\n      const list = roomState.ydoc.getArray(chatType);\n      list.forEach((item, index) => {\n        if (!isChatItem(item)) return;\n        if (item.messageId === inReplyTo) {\n          const replyMap = new Map(item.replies);\n          replyMap.set(text, (replyMap.get(text) || 0) + 1);\n          const replies = [...replyMap.entries()];\n          replies.sort(compareReply);\n          list.delete(index, 1);\n          list.insert(index, [{ ...item, replies }]);\n        }\n      });\n      setChatList(list.toArray().filter(isChatItem));\n    },\n    [roomId, userId, chatType]\n  );\n\n  return {\n    chatList,\n    sendChat,\n    replyChat,\n  };\n};\n","// @ts-nocheck XXX ckeditor5 doesn't come with types\n\nimport React from \"react\";\nimport { CKEditor } from \"@ckeditor/ckeditor5-react\";\nimport CustomEditor from \"@daishi/ckeditor5-build-inline-custom\";\n\nimport \"./WysiwygEditor.css\";\n\nconst config = {\n  toolbar: [\n    \"specialCharacters\",\n    \"|\",\n    \"bold\",\n    \"italic\",\n    \"link\",\n    \"blockQuote\",\n    \"|\",\n    \"imageUpload\",\n    \"insertTable\",\n    \"mediaEmbed\",\n    \"|\",\n    \"undo\",\n    \"redo\",\n  ],\n  balloonToolbar: [\n    \"heading\",\n    \"|\",\n    \"bulletedList\",\n    \"numberedList\",\n    \"indent\",\n    \"outdent\",\n  ],\n  link: {\n    addTargetToExternalLinks: true,\n  },\n};\n\nconst initEditor = (editor) => {\n  editor.plugins.get(\"SpecialCharacters\").addItems(\"Emoji\", [\n    { title: \"smiley face\", character: \"😊\" },\n    { title: \"rocket\", character: \"🚀\" },\n    { title: \"wind blowing face\", character: \"🌬️\" },\n    { title: \"floppy disk\", character: \"💾\" },\n    { title: \"heart\", character: \"❤️\" },\n  ]);\n};\n\nexport const WysiwygEditor = React.memo<{\n  registerClear: (clear: () => void) => void;\n  onChange: (data: string) => void;\n  onMetaEnter: () => void;\n}>(({ registerClear, onChange, onMetaEnter }) => (\n  <CKEditor\n    editor={CustomEditor}\n    config={config}\n    onReady={(editor) => {\n      const onKeydown = (event: KeyboardEvent) => {\n        if (event.metaKey && event.code === \"Enter\") {\n          onMetaEnter();\n        }\n      };\n      editor.sourceElement.addEventListener(\"keydown\", onKeydown);\n      registerClear(() => {\n        editor.setData(\"\");\n      });\n      initEditor(editor);\n    }}\n    onChange={(_event, editor) => {\n      const data = editor.getData();\n      onChange(data);\n    }}\n  />\n));\n","import React, { useState, useRef, useEffect, useCallback } from \"react\";\nimport DOMPurify from \"dompurify\";\n\nimport \"./MomentaryChat.css\";\nimport { useMomentaryChat, ChatItem } from \"../hooks/useMomentaryChat\";\nimport { EmojiPicker } from \"../utils/emoji\";\nimport { WysiwygEditor } from \"./WysiwygEditor\";\nimport { useNotification } from \"../hooks/useNotification\";\n\nconst MAX_CHAT_TEXT_SIZE = 1 * 1024 * 1024;\n\ntype ChatList = ReturnType<typeof useMomentaryChat>[\"chatList\"];\ntype ReplyChat = ReturnType<typeof useMomentaryChat>[\"replyChat\"];\n\nconst sanitize = (text: string) => ({\n  __html: DOMPurify.sanitize(text, { ADD_ATTR: [\"target\"] }),\n});\n\nconst getChatTime = (item: ChatItem) =>\n  new Date(item.createdAt).toLocaleString().split(\" \")[1].slice(0, -3);\n\nconst MomentaryChatContentPart = React.memo<{\n  item: ChatItem;\n  replyChat: ReplyChat;\n}>(({ item, replyChat }) => {\n  const [openEmojiPicker, setOpenEmojiPicker] = useState(false);\n  const reply = (text: string) => replyChat(text, item.messageId);\n  return (\n    <li key={item.messageId} className=\"MomentaryChat-listPart\">\n      {openEmojiPicker && (\n        <EmojiPicker\n          onSelect={(e) => {\n            reply(e.native);\n            setOpenEmojiPicker(false);\n          }}\n          style={{ width: \"100%\" }}\n        />\n      )}\n      <div className=\"MomentaryChat-listPart-header\">\n        <div className=\"MomentaryChat-iconButton-container\">\n          <div className=\"MomentaryChat-iconButton\">\n            <button\n              type=\"button\"\n              onClick={() => {\n                setOpenEmojiPicker(!openEmojiPicker);\n              }}\n            >\n              +\n            </button>\n          </div>\n        </div>\n        <span className=\"MomentaryChat-nickname\">\n          {item.nickname || \"No Name\"}\n        </span>\n        <span className=\"MomentaryChat-time\">{getChatTime(item)}</span>\n      </div>\n      <div\n        className=\"MomentaryChat-text ck-content\"\n        dangerouslySetInnerHTML={sanitize(item.text)}\n      />\n      {(item.replies || []).map(([text, count]) => (\n        <button\n          key={text}\n          className=\"MomentaryChat-icon\"\n          type=\"button\"\n          onClick={() => reply(text)}\n        >\n          {text} {count}\n        </button>\n      ))}\n    </li>\n  );\n});\n\nconst MomentaryChatContent = React.memo<{\n  chatList: ChatList;\n  replyChat: ReplyChat;\n}>(({ chatList, replyChat }) => {\n  const chatListRef = useRef<HTMLUListElement | null>(null);\n  const latestMessageId = chatList[0]?.messageId;\n  useEffect(() => {\n    if (chatListRef.current && latestMessageId) {\n      chatListRef.current.scrollTop = chatListRef.current.scrollHeight;\n    }\n  }, [latestMessageId]);\n\n  return (\n    <ul className=\"MomentaryChat-list\" ref={chatListRef}>\n      {chatList.map((item) => (\n        <MomentaryChatContentPart\n          key={item.messageId}\n          item={item}\n          replyChat={replyChat}\n        />\n      ))}\n    </ul>\n  );\n});\n\nexport const MomentaryChat = React.memo<{\n  roomId: string;\n  userId: string;\n  nickname: string;\n  uniqueId?: string;\n}>(({ roomId, userId, nickname, uniqueId }) => {\n  const containerRef = useRef<HTMLDivElement | null>(null);\n  const { chatList, sendChat, replyChat } = useMomentaryChat(\n    roomId,\n    userId,\n    nickname,\n    uniqueId\n  );\n\n  const clearRef = useRef<() => void>();\n  const registerClear = (clear: () => void) => {\n    clearRef.current = clear;\n  };\n\n  const [canSend, setCanSend] = useState(false);\n  const textRef = useRef(\"\");\n  const setText = useCallback((t: string) => {\n    textRef.current = t;\n    setCanSend(!!t && t.length <= MAX_CHAT_TEXT_SIZE);\n  }, []);\n  const sendText = useCallback(() => {\n    if (textRef.current && textRef.current.length <= MAX_CHAT_TEXT_SIZE) {\n      sendChat(textRef.current);\n      setText(\"\");\n      if (clearRef.current) {\n        clearRef.current();\n      }\n    }\n  }, [sendChat, setText]);\n\n  const sendNotification = useNotification();\n  const latestChatItem = chatList[0];\n  useEffect(() => {\n    if (\n      latestChatItem &&\n      latestChatItem.createdAt > Date.now() - 10 * 1000 &&\n      new RegExp(`@${nickname}\\\\b`).test(latestChatItem.text)\n    ) {\n      sendNotification(\"You got a new message!\");\n    }\n  }, [nickname, latestChatItem, sendNotification]);\n\n  return (\n    <div className=\"MomentaryChat-container\" ref={containerRef}>\n      <MomentaryChatContent chatList={chatList} replyChat={replyChat} />\n      <div className=\"MomentaryChat-editor\">\n        <WysiwygEditor\n          registerClear={registerClear}\n          onChange={setText}\n          onMetaEnter={sendText}\n        />\n      </div>\n      <div className=\"MomentaryChat-button\">\n        <button type=\"button\" onClick={sendText} disabled={!canSend}>\n          Send\n        </button>\n      </div>\n    </div>\n  );\n});\n\nexport default MomentaryChat;\n","import { useEffect, useCallback, useRef } from \"react\";\n\nexport const useNotification = () => {\n  const notificationRef = useRef<Notification>();\n  const sendNotification = useCallback((mesg: string) => {\n    if (Notification.permission === \"granted\") {\n      if (notificationRef.current) {\n        notificationRef.current.close();\n      }\n      notificationRef.current = new Notification(mesg);\n    }\n  }, []);\n  useEffect(() => {\n    if (Notification.permission !== \"granted\") {\n      Notification.requestPermission();\n    }\n  }, []);\n  return sendNotification;\n};\n"],"sourceRoot":""}