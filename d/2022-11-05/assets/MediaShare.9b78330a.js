import{r,u as R,s as j,j as v,a as i,w,F as O}from"./index.3d62984e.js";import{g as x,a as D,i as F}from"./SingleRoom.8d7cac55.js";const $=async()=>{try{const e={video:!0},t=await navigator.mediaDevices.getDisplayMedia(e),[a]=t.getVideoTracks();return{stream:t,dispose:()=>{a.stop()}}}catch{return null}},q=(e,t,a,h,y)=>{const c=`${y||"mediaShare"}Video`,[f,d]=r.exports.useState(null),[l,p]=r.exports.useState({}),M=r.exports.useRef([]);r.exports.useEffect(()=>()=>{M.current.forEach(n=>n())},[]);const g=([o,n])=>{var S;if(n.readyState==="ended"||(S=l[o])!=null&&S.getTracks().includes(n))return;p(m=>({...m,[o]:new MediaStream([n])}));const u=()=>{p(m=>({...m,[o]:null}))};n.addEventListener("ended",u),M.current.push(()=>{n.removeEventListener("ended",u)})},E=R(x(e,t).trackMap);return Object.entries(E[c]||{}).forEach(g),r.exports.useEffect(()=>{const o=x(e,t);return o.addMediaType(c),()=>{o.removeMediaType(c)}},[e,t,c]),r.exports.useEffect(()=>{const o=x(e,t);let n=null;return a&&(async()=>{let u;if(a==="SCREEN"){const b=await $();if(!b){h();return}u=b}else u=await D(a.video);const[S]=u.stream.getVideoTracks();o.addTrack(c,S),d(u.stream),S.addEventListener("ended",()=>{n&&n(),n=null});const m=()=>{o.removeTrack(c),u.dispose(),d(null),h()};n===!1?m():n=m})(),()=>{n&&n(),n=!1}},[e,t,c,a,h]),{videoStream:f,videoStreamMap:l}},L=e=>F(e)&&F(e.info)&&typeof e.info.nickname=="string",A=(e,t)=>{const[a,h]=r.exports.useState({});return r.exports.useEffect(()=>{const y=x(e,t);return j(y.faceImages,()=>{h(c=>{const f={...c};let d=!1;return Object.entries(y.faceImages).forEach(([l,p])=>{l!==t&&(!L(p)||(f[l]?p.info.nickname!==f[l]&&(f[l]=p.info.nickname,d=!0):(f[l]=p.info.nickname,d=!0)))}),d?f:c})})},[e,t]),a},T=r.exports.memo(({nickname:e,stream:t})=>{const a=r.exports.useRef(null);return r.exports.useEffect(()=>{t&&a.current&&(a.current.srcObject=t)},[t]),v("div",{className:"MediaShare-card",children:[i("video",{className:"MediaShare-video",ref:a,autoPlay:!0,muted:!0}),i("div",{className:"MediaShare-nickname",children:e})]})}),H=r.exports.memo(({roomId:e,userId:t,nickname:a,uniqueId:h})=>{const y=w(),[c,f]=r.exports.useState(""),[d,l]=r.exports.useState(null),p=r.exports.useCallback(()=>{l(null)},[]),{videoStream:M,videoStreamMap:g}=q(e,t,d,p,h),E=A(e,t),[o,n]=r.exports.useState("grid"),u=(M?1:0)+Object.values(g).filter(s=>s).length,S=Math.ceil(Math.sqrt(u)),m=Math.ceil(u/S),b=o==="grid"?{gridTemplateColumns:`repeat(${S}, 1fr)`,gridTemplateRows:`repeat(${m}, ${100/m}%)`}:{gridTemplateRows:Array(u).fill("100%").join(" ")},k=r.exports.useRef(null),[V,N]=r.exports.useState(!1);return v("div",{className:"MediaShare-container",ref:k,children:[v("div",{className:"MediaShare-toolbar",children:[!V&&i("button",{type:"button",onClick:async()=>{if(k.current)try{await k.current.requestFullscreen(),N(!0),k.current.onfullscreenchange=()=>{N(document.fullscreenElement===k.current)}}catch{}},children:"Enter Fullscreen"}),V&&i("button",{type:"button",onClick:async()=>{try{document.exitFullscreen(),N(!1)}catch{}},children:"Exit Fullscreen"}),v("select",{value:o,onChange:s=>n(s.target.value),children:[i("option",{value:"grid",children:"Display in Grid"}),i("option",{value:"vertical",children:"Display Vertically"})]}),d!==null&&i("button",{type:"button",onClick:p,children:"Stop sharing"}),d===null&&i("button",{type:"button",onClick:()=>l("SCREEN"),children:"Start Screen Share"}),d===null&&v(O,{children:[v("select",{value:c,onChange:s=>f(s.target.value),children:[i("option",{value:"",disabled:!0,children:"Select Camera to Share"}),y.map(s=>i("option",{value:s.deviceId,children:s.label},s.deviceId))]}),c&&i("button",{type:"button",onClick:()=>l({video:c}),children:"Start Video Share"})]})]}),v("div",{className:"MediaShare-body",style:b,children:[M&&i(T,{nickname:a,stream:M}),Object.keys(g).map(s=>{const C=g[s];return C?i(T,{nickname:E[s]||"No Name",stream:C},s):null})]})]})});export{H as MediaShare,H as default};
