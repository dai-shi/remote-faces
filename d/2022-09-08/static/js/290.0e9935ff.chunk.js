(self.webpackChunkremote_faces_web=self.webpackChunkremote_faces_web||[]).push([[290],{17904:(e,t,n)=>{"use strict";n.r(t),n.d(t,{createRoom:()=>l});var a=n(5347),r=n(93057),o=n(65954),s=n(1239),i=n(50634),c=n(76996);let d=0;var u=n(52780);const p=a.Ue,w=new Map,f=async(e,t)=>{const n=`${e} ${t}`;let a=w.get(n);return a||(a=(await(0,o.JQ)(n)).slice(0,c.W),w.set(n,a)),a},l=async(e,t,n,a,w,l)=>{let g=!1;const y=(()=>{const e=new Map;return{setAcceptingMediaTypes:(t,n)=>{const a=e.get(t.peer);a&&(a.acceptingMediaTypes=n)},getAcceptingMediaTypes:t=>{const n=e.get(t.peer);return n?n.acceptingMediaTypes:[]},addConn:(t,n)=>{if(e.get(t))throw new Error("addConn: already exists");const a={peerIndex:(d+=1,d),peer:t,userId:n,audioWorkers:new Map,vidoeSetImages:new Map};return e.set(a.peer,{conn:a,acceptingMediaTypes:[]}),a},getConn:t=>{const n=e.get(t);return n?n.conn:null},findConn:t=>{const n=Array.from(e.values()).find((e=>e.conn.peerIndex===t));return n?n.conn:null},delConn:t=>{const n=e.get(t.peer);if(!n||n.conn!==t)throw new Error("delConn: does not exist");e.delete(t.peer)},getPeerIndexList:()=>Array.from(e.values()).map((e=>e.conn.peerIndex)),forEachConns:t=>{Array.from(e.values()).forEach((e=>{t(e.conn)}))},size:()=>e.size}})();let m=[];const h=e.slice(0,c.W),b=await(0,o.I1)(e.slice(c.W));n({type:"INITIALIZING_PEER",peerIndex:0});const I=await p({repo:(0,o.Ze)(),config:{Addresses:{Swarm:[(0,s.Q_)()||"/dns4/wrtc-star1.par.dwebops.pub/tcp/443/wss/p2p-webrtc-star/"]},Bootstrap:[]}}),E=(await I.id()).id;await I.pubsub.subscribe(h,(e=>S(e))),await I.pubsub.subscribe(`${h} ${E}`,(e=>S(e)));const v=async(e,t)=>{try{console.log("payload to encrypt",e,t);for await(const n of(0,o.Ri)(JSON.stringify(t),b))await I.pubsub.publish(e,new Uint8Array(n),{})}catch(n){console.error("sendPayload",n)}},C=async e=>{if(g)return;const n={userId:t,data:e,mediaTypes:m};await v(h,n)};const T=new Map,k=async(e,t)=>{try{if(!(0,i.Kn)(t))return;(async(e,t)=>{Array.isArray(t)&&t.every((e=>"string"===typeof e))&&y.setAcceptingMediaTypes(e,t)})(e,t.mediaTypes),((e,t)=>{const n={userId:e.userId,peerIndex:e.peerIndex,mediaTypes:y.getAcceptingMediaTypes(e)};try{w(t,n)}catch(a){console.warn("receiveData",a)}})(e,t.data)}catch(n){console.info("Error in handlePayload",n,t)}},S=async e=>{if(g)return;if(!("from"in e))return;if(e.from.toString()===E.toString())return;const t=await(async e=>{try{const t=await(0,o.KI)(e,b);if(null===t)return;const n=JSON.parse(t);return console.log("decrypted payload",n),n}catch(t){return void console.info("Error in parsePayload",t,e)}})(e.data);if(void 0===t)return;const r=(e=>{if(!(0,i.Kn)(e))return null;const t=e.userId;return"string"!==typeof t?null:t})(t);let s=y.getConn(e.from.toString());s||(r?s=((e,t)=>{const r=y.addConn(e,t);return a(r.peerIndex),n({type:"NEW_CONNECTION",peerIndex:r.peerIndex}),r})(e.from.toString(),r):console.warn("cannot initialize conn without user id")),s&&await k(s,t);const c=y.getPeerIndexList();n({type:"CONNECTED_PEERS",peerIndexList:c})},A=async()=>{if(g)return;const e=await I.pubsub.peers(h);if(y.forEachConns((t=>{e.some((e=>e.toString()===t.peer))||(y.delConn(t),n({type:"CONNECTION_CLOSED",peerIndex:t.peerIndex}))})),!e.length)return n({type:"CONNECTING_SEED_PEERS"}),await(0,r._)(1e3),void A();y.size()||await C(null),await(0,r._)(5e3),A()};A();const x=new WeakMap,M=e=>{e&&e()},W=new Map;return{broadcastData:C,sendData:async(e,n)=>{if(g)return;const a=y.findConn(n);if(!a)return;const r={userId:t,data:e,mediaTypes:m};await(async(e,t)=>{const n=`${h} ${e.peer}`;await v(n,t)})(a,r)},acceptMediaTypes:t=>{g||(T.forEach(((e,n)=>{t.includes(n)||(e.forEach((e=>e())),T.delete(n))})),t.forEach((t=>{if(!T.has(t))if(t.endsWith("Audio"))(async t=>{const n=[];T.set(t,n);const a=await f(e,t),r=async e=>{if(!("from"in e))return;if(e.from.toString()===E.toString())return;const a=y.getConn(e.from.toString());if(!a)return void console.warn("conn not ready");const r={userId:a.userId,peerIndex:a.peerIndex,mediaTypes:y.getAcceptingMediaTypes(a)};if(!a.audioWorkers.has(t)){const e=new AudioContext,o=e.createMediaStreamDestination();let s=0,i=0;const c=new Worker("audio-decoder.js",{type:"module"});c.onmessage=t=>{const n=new Float32Array(t.data);i||(s=e.currentTime),s+=.06,i+=1;const a=e.createBuffer(1,2880,48e3);a.copyToChannel(n,0);const r=e.createBufferSource();r.buffer=a,r.connect(o),r.onended=()=>{i-=1},r.start(s)},a.audioWorkers.set(t,c);const d=o.stream.getAudioTracks()[0];l(t,await(0,u.sW)(d),r),n.push((()=>{e.close(),d.dispatchEvent(new Event("ended")),c.terminate(),a.audioWorkers.delete(t)}))}const s=await(0,o.Km)(e.data.buffer,e.data.byteOffset,e.data.byteLength,b),i=a.audioWorkers.get(t);i&&s.forEach((e=>{i.postMessage([e],[e])}))};I.pubsub.subscribe(a,r),n.unshift((()=>{I.pubsub.unsubscribe(a,r)}))})(t);else{if(!t.endsWith("Video"))throw new Error("pubsubRoom: cannot guess mediaType (Audio/Video)");(async t=>{const n=[];T.set(t,n);const a=await f(e,t),r=async e=>{if(!("from"in e))return;if(e.from.toString()===E.toString())return;const a=y.getConn(e.from.toString());if(!a)return void console.warn("conn not ready");const r={userId:a.userId,peerIndex:a.peerIndex,mediaTypes:y.getAcceptingMediaTypes(a)};if(!a.vidoeSetImages.has(t)){const{videoTrack:e,setImage:o}=(0,u.FX)();a.vidoeSetImages.set(t,o),l(t,e,r),n.push((()=>{e.dispatchEvent(new Event("ended")),a.vidoeSetImages.delete(t)}))}const s=a.vidoeSetImages.get(t);try{const t=await(0,o.KI)(e.data,b);s&&t&&s(t)}catch(i){console.info("Error in parse for video media",i)}};I.pubsub.subscribe(a,r),n.unshift((()=>{I.pubsub.unsubscribe(a,r)}))})(t)}})),m=t,C(null))},addTrack:async(t,n)=>{if(!g){if(W.has(t))throw new Error(`track is already added for ${t}`);if(W.set(t,n),t.endsWith("Audio"))(async(t,n)=>{M(x.get(n));const a=new MediaStream([n]),r=new AudioContext,s=r.createMediaStreamSource(a);await r.audioWorklet.addModule("audio-encoder.js");const i=new AudioWorkletNode(r,"audio-encoder"),c=await f(e,t),d=[];i.port.onmessage=async e=>{if(d.push(e.data),d.length<17)return;const t=await(0,o.jh)(d.splice(0,d.length),b);I.pubsub.publish(c,new Uint8Array(t),{})},s.connect(i),x.set(n,(()=>{r.close()}))})(t,n);else{if(!t.endsWith("Video"))throw new Error("pubsubRoom: cannot guess mediaType (Audio/Video)");(async(t,n)=>{M(x.get(n));const a=await f(e,t),{getImage:s}=await(0,u.gG)(n);let i=!1;const c=async()=>{if(i)return;const e=await s();if(e)for await(const t of(0,o.Ri)(e,b)){if(i)return;await I.pubsub.publish(a,new Uint8Array(t),{}),await(0,r._)(1e3)}else await(0,r._)(5e3);c()};c(),x.set(n,(()=>{i=!0}))})(t,n)}}},removeTrack:e=>{if(g)return;const t=W.get(e);t?(W.delete(e),M(x.get(t))):console.log("track is already removed for",e)},dispose:async()=>{g=!0,await I.pubsub.unsubscribe(`${h} ${E}`,S),await I.pubsub.unsubscribe(h,S),await I.stop()}}}},52780:(e,t,n)=>{"use strict";n.d(t,{FX:()=>i,gG:()=>s,sW:()=>o,xm:()=>r});const a=new WeakMap,r=(e,t)=>{if(a.has(e))return e;a.set(e,!0);const n=function(){let a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3;if("ended"===e.readyState)return;const r=t.getTransceivers().find((t=>t.receiver.track===e));!r||"inactive"!==r.currentDirection&&"sendonly"!==r.currentDirection?a<64e3&&setTimeout((()=>{n(2*a)}),a):(e.stop(),e.dispatchEvent(new Event("ended")))};return e.addEventListener("mute",(()=>n())),e},o=e=>new Promise((async(t,n)=>{try{const n=new RTCPeerConnection,a=new RTCPeerConnection;n.addEventListener("icecandidate",(e=>{let{candidate:t}=e;t&&a.addIceCandidate(t)})),a.addEventListener("icecandidate",(e=>{let{candidate:t}=e;t&&n.addIceCandidate(t)})),a.addEventListener("track",(e=>{t(e.track)})),e.addEventListener("ended",(()=>{n.close(),a.close()})),n.addTrack(e);const r=await n.createOffer();await n.setLocalDescription(r),await a.setRemoteDescription(r);const o=await a.createAnswer();await a.setLocalDescription(o),await n.setRemoteDescription(o)}catch(a){n(a)}})),s=async e=>{if("video"!==e.kind)throw new Error("track kind is not video");const t=document.createElement("canvas"),n=t.getContext("2d"),a=new ImageCapture(e);return{getImage:async()=>{try{const e=await a.grabFrame();return t.width=e.width,t.height=e.height,n.drawImage(e,0,0),t.toDataURL("image/jpeg")}catch(e){return console.log("failed to grab frame from viedeo track",e),null}}}},i=()=>{const e=document.createElement("canvas"),t=e.getContext("2d"),n=e.captureStream(),[a]=n.getVideoTracks();return{videoTrack:a,setImage:async n=>{const a=await(r=n,new Promise(((e,t)=>{const n=new Image;n.onload=()=>e(n),n.onerror=t,n.src=r})));var r;e.width=a.width,e.height=a.height,t.drawImage(a,0,0)}}}},45022:()=>{},32296:()=>{},91586:()=>{},77265:()=>{},59983:()=>{},97868:()=>{},17847:()=>{},75715:()=>{},45089:()=>{},31566:()=>{},95745:()=>{},50471:()=>{},71632:()=>{}}]);
//# sourceMappingURL=290.0e9935ff.chunk.js.map