"use strict";(self.webpackChunkremote_faces_web=self.webpackChunkremote_faces_web||[]).push([[378],{10378:(e,t,r)=>{r.r(t),r.d(t,{MomentaryChat:()=>v,default:()=>N});var a=r(56167),n=r(60854),s=r.n(n),o=r(65954),c=r(50634),i=r(36620);const l=e=>Array.isArray(e)&&2===e.length&&"string"===typeof e[0]&&"number"===typeof e[1],d=e=>(0,c.Kn)(e)&&"string"===typeof e.nickname&&"string"===typeof e.messageId&&"number"===typeof e.createdAt&&"string"===typeof e.text&&(e=>Array.isArray(e)&&e.every(l))(e.replies),u=(e,t)=>{const r=t[1]-e[1];return 0===r?e[0].length-t[0].length:r};var m=r(4497),h=r(11913),y=r(19375),g=r.n(y),f=r(37878);const C={toolbar:["specialCharacters","|","bold","italic","link","blockQuote","|","imageUpload","insertTable","mediaEmbed","|","undo","redo"],balloonToolbar:["heading","|","bulletedList","numberedList","indent","outdent"],link:{addTargetToExternalLinks:!0}},p=(0,a.memo)((e=>{let{registerClear:t,onChange:r,onMetaEnter:a}=e;return(0,f.jsx)(h.CKEditor,{editor:g(),config:C,onReady:e=>{e.sourceElement.addEventListener("keydown",(e=>{e.metaKey&&"Enter"===e.code&&a()})),t((()=>{e.setData("")})),(e=>{e.plugins.get("SpecialCharacters").addItems("Emoji",[{title:"smiley face",character:"\ud83d\ude0a"},{title:"rocket",character:"\ud83d\ude80"},{title:"wind blowing face",character:"\ud83c\udf2c\ufe0f"},{title:"floppy disk",character:"\ud83d\udcbe"},{title:"heart",character:"\u2764\ufe0f"}])})(e)},onChange:(e,t)=>{const a=t.getData();r(a)}})})),b=1048576,x=e=>new Date(e.createdAt).toLocaleString().split(" ")[1].slice(0,-3),k=(0,a.memo)((e=>{let{item:t,replyChat:r}=e;const[n,o]=(0,a.useState)(!1),c=e=>r(e,t.messageId);return(0,f.jsxs)("li",{className:"MomentaryChat-listPart",children:[n&&(0,f.jsx)(m.h5,{onSelect:e=>{c(e.native),o(!1)},style:{width:"100%"}}),(0,f.jsxs)("div",{className:"MomentaryChat-listPart-header",children:[(0,f.jsx)("div",{className:"MomentaryChat-iconButton-container",children:(0,f.jsx)("div",{className:"MomentaryChat-iconButton",children:(0,f.jsx)("button",{type:"button",onClick:()=>{o(!n)},children:"+"})})}),(0,f.jsx)("span",{className:"MomentaryChat-nickname",children:t.nickname||"No Name"}),(0,f.jsx)("span",{className:"MomentaryChat-time",children:x(t)})]}),(0,f.jsx)("div",{className:"MomentaryChat-text ck-content",dangerouslySetInnerHTML:(i=t.text,{__html:s().sanitize(i,{ADD_ATTR:["target"]})})}),(t.replies||[]).map((e=>{let[t,r]=e;return(0,f.jsxs)("button",{className:"MomentaryChat-icon",type:"button",onClick:()=>c(t),children:[t," ",r]},t)}))]},t.messageId);var i})),j=(0,a.memo)((e=>{var t;let{chatList:r,replyChat:n}=e;const s=(0,a.useRef)(null),o=null===(t=r[0])||void 0===t?void 0:t.messageId;return(0,a.useEffect)((()=>{s.current&&o&&(s.current.scrollTop=s.current.scrollHeight)}),[o]),(0,f.jsx)("ul",{className:"MomentaryChat-list",ref:s,children:r.map((e=>(0,f.jsx)(k,{item:e,replyChat:n},e.messageId)))})})),v=(0,a.memo)((e=>{let{roomId:t,userId:r,nickname:n,uniqueId:s}=e;const c=(0,a.useRef)(null),{chatList:l,sendChat:m,replyChat:h}=((e,t,r,n)=>{const s=`${n||"momentray"}Chat`,[c,l]=(0,a.useState)([]);return(0,a.useEffect)((()=>{const r=(0,i.V)(e,t).ydoc.getArray(s),a=()=>{l(r.toArray().filter(d))};return r.observe(a),a(),()=>{r.unobserve(a)}}),[e,t,s]),{chatList:c,sendChat:(0,a.useCallback)((a=>{const n=(0,i.V)(e,t).ydoc.getArray(s),c={nickname:r,messageId:(0,o.Ze)(),createdAt:Date.now(),text:a,replies:[]};n.unshift([c]),n.length>100&&n.delete(n.length-1,1),l(n.toArray().filter(d))}),[e,t,r,s]),replyChat:(0,a.useCallback)(((r,a)=>{const n=(0,i.V)(e,t).ydoc.getArray(s);n.forEach(((e,t)=>{if(d(e)&&e.messageId===a){const a=new Map(e.replies);a.set(r,(a.get(r)||0)+1);const s=[...a.entries()];s.sort(u),n.delete(t,1),n.insert(t,[{...e,replies:s}])}})),l(n.toArray().filter(d))}),[e,t,s])}})(t,r,n,s),y=(0,a.useRef)(),[g,C]=(0,a.useState)(!1),x=(0,a.useRef)(""),k=(0,a.useCallback)((e=>{x.current=e,C(!!e&&e.length<=b)}),[]),v=(0,a.useCallback)((()=>{x.current&&x.current.length<=b&&(m(x.current),k(""),y.current&&y.current())}),[m,k]),N=(()=>{const e=(0,a.useRef)(),t=(0,a.useCallback)((t=>{"granted"===Notification.permission&&(e.current&&e.current.close(),e.current=new Notification(t))}),[]);return(0,a.useEffect)((()=>{"granted"!==Notification.permission&&Notification.requestPermission()}),[]),t})(),M=l[0];return(0,a.useEffect)((()=>{M&&M.createdAt>Date.now()-1e4&&new RegExp(`@${n}\\b`).test(M.text)&&N("You got a new message!")}),[n,M,N]),(0,f.jsxs)("div",{className:"MomentaryChat-container",ref:c,children:[(0,f.jsx)(j,{chatList:l,replyChat:h}),(0,f.jsx)("div",{className:"MomentaryChat-editor",children:(0,f.jsx)(p,{registerClear:e=>{y.current=e},onChange:k,onMetaEnter:v})}),(0,f.jsx)("div",{className:"MomentaryChat-button",children:(0,f.jsx)("button",{type:"button",onClick:v,disabled:!g,children:"Send"})})]})})),N=v}}]);
//# sourceMappingURL=378.57efc7b3.chunk.js.map